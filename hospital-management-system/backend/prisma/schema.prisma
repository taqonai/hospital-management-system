// Hospital Management System - Prisma Schema
// Multi-tenant SaaS Architecture

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== TENANT & ORGANIZATION ====================

model Hospital {
  id              String   @id @default(uuid())
  name            String
  code            String   @unique
  address         String
  city            String
  state           String
  country         String
  zipCode         String
  phone           String
  email           String
  whatsappNumber  String?
  website         String?
  logo            String?
  licenseNumber   String
  accreditation   String?
  bedCapacity     Int      @default(0)
  isActive        Boolean  @default(true)
  settings        Json     @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  departments     Department[]
  users           User[]
  patients        Patient[]
  appointments    Appointment[]
  admissions      Admission[]
  invoices        Invoice[]
  inventory       InventoryItem[]
  beds            Bed[]
  labOrders       LabOrder[]
  imagingOrders   ImagingOrder[]
  auditLogs       AuditLog[]
  employees       Employee[]
  smartOrders     SmartOrder[]
  clinicalNotes   ClinicalNote[]
  aiScribeSessions AiScribeSession[]
  customRoles      CustomRole[]
  rbacAuditLogs    RBACauditLog[]
  doctorSlots      DoctorSlot[]
  doctorAbsences   DoctorAbsence[]
  noShowLogs       NoShowLog[]
  stageAlerts      StageAlert[]
  holidays         HospitalHoliday[]

  // Insurance Coding
  icd10Codes       ICD10Code[]
  cptCodes         CPTCode[]
  cptModifiers     CPTModifier[]
  insurancePayers  InsurancePayer[]
  icd10CptMappings ICD10CPTMapping[]

  // A'mad Precision Health Platform
  healthDataPoints     HealthDataPoint[]
  genomicProfiles      GenomicProfile[]
  patientConsents      PatientConsent[]
  recommendations      Recommendation[]
  dailyHealthScores    DailyHealthScore[]
  foodItems            FoodItem[]
  clinicianHealthNotes ClinicianHealthNote[]

  // CRM Module
  crmLeads             CRMLead[]
  crmCommunications    CRMCommunication[]
  crmTemplates         CRMTemplate[]
  crmActivities        CRMActivity[]
  crmTasks             CRMTask[]
  crmCampaigns         CRMCampaign[]
  crmSurveys           CRMSurvey[]
  crmTags              CRMTag[]
  crmSettings          CRMSettings?

  // Consultant Referrals
  referrals            ConsultantReferral[]

  // Emergency On-Call System
  emergencyPages       EmergencyPage[]

  // Procurement Module
  suppliers              Supplier[]
  purchaseRequisitions   PurchaseRequisition[]
  purchaseOrders         PurchaseOrder[]

  @@map("hospitals")
}

model Department {
  id           String   @id @default(uuid())
  hospitalId   String
  name         String
  code         String
  description  String?
  floor        String?
  phone        String?
  email        String?
  headDoctorId String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  hospital        Hospital         @relation(fields: [hospitalId], references: [id])
  doctors         Doctor[]
  nurses          Nurse[]
  beds            Bed[]
  specializations Specialization[]
  referrals       ConsultantReferral[]

  // Procurement Module
  purchaseRequisitions PurchaseRequisition[]

  @@unique([hospitalId, code])
  @@map("departments")
}

model Specialization {
  id           String   @id @default(uuid())
  departmentId String
  name         String
  code         String
  description  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  department Department @relation(fields: [departmentId], references: [id])
  doctors    Doctor[]

  @@unique([departmentId, code])
  @@map("specializations")
}

// ==================== USER MANAGEMENT ====================

model User {
  id              String    @id @default(uuid())
  hospitalId      String
  email           String
  password        String
  firstName       String
  lastName        String
  phone           String?
  avatar          String?
  role            UserRole
  isActive        Boolean   @default(true)
  isEmailVerified Boolean   @default(false)
  lastLogin       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  hospital        Hospital           @relation(fields: [hospitalId], references: [id])
  doctor          Doctor?
  nurse           Nurse?
  patient         Patient?
  employee        Employee?
  permissions     UserPermission[]
  sessions        Session[]
  auditLogs       AuditLog[]
  notifications   Notification[]
  orderedSmartOrders  SmartOrder[]     @relation("OrderedByUser")
  executedOrderItems  SmartOrderItem[] @relation("ExecutedByUser")
  authoredClinicalNotes ClinicalNote[] @relation("ClinicalNoteAuthor")
  signedClinicalNotes   ClinicalNote[] @relation("ClinicalNoteSigner")
  aiScribeSessions      AiScribeSession[]
  customRoles           UserCustomRole[]

  // A'mad Precision Health Platform
  clinicianHealthNotes  ClinicianHealthNote[] @relation("ClinicianHealthNotes")

  // CRM Module
  assignedLeads         CRMLead[]           @relation("LeadAssignment")
  crmCommunications     CRMCommunication[]  @relation("CRMCommunicationInitiator")
  crmTemplatesCreated   CRMTemplate[]       @relation("CRMTemplateCreator")
  crmActivities         CRMActivity[]       @relation("CRMActivityPerformer")
  crmTasksAssigned      CRMTask[]           @relation("CRMTaskAssignee")
  crmTasksCreated       CRMTask[]           @relation("CRMTaskAssigner")
  crmCampaignsCreated   CRMCampaign[]       @relation("CRMCampaignCreator")
  crmSurveysCreated     CRMSurvey[]         @relation("CRMSurveyCreator")

  // Laboratory Module
  orderedLabOrders      LabOrder[]          @relation("LabOrderOrderedBy")
  verifiedLabOrders     LabOrder[]          @relation("LabOrderVerifiedBy")
  collectedSamples      LabSample[]         @relation("SampleCollectedBy")
  receivedSamples       LabSample[]         @relation("SampleReceivedBy")
  verifiedSamples       LabSample[]         @relation("SampleVerifiedBy")
  sampleCustodyLogs     SampleCustodyLog[]

  // Procurement Module
  prRequestedBy         PurchaseRequisition[] @relation("PRRequestedBy")
  prApprovals           PRApproval[]          @relation("PRApprover")
  poApprovals           POApproval[]          @relation("POApprover")
  grnReceivedBy         GoodsReceiptNote[]    @relation("GRNReceivedBy")
  emergencyPages        EmergencyPage[]       @relation("UserPages")

  @@unique([hospitalId, email])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  HOSPITAL_ADMIN
  DOCTOR
  NURSE
  RECEPTIONIST
  LAB_TECHNICIAN
  PATHOLOGIST
  PHARMACIST
  RADIOLOGIST
  ACCOUNTANT
  PATIENT
  HR_MANAGER
  HR_STAFF
  HOUSEKEEPING_MANAGER
  HOUSEKEEPING_STAFF
  MAINTENANCE_STAFF
  SECURITY_STAFF
  DIETARY_STAFF
  MARKETING
  PROCUREMENT_MANAGER
  PROCUREMENT_STAFF
}

model UserPermission {
  id         String   @id @default(uuid())
  userId     String
  permission String
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, permission])
  @@map("user_permissions")
}

// Custom Role created by Hospital Admin
model CustomRole {
  id          String   @id @default(uuid())
  hospitalId  String
  name        String
  description String?
  isSystem    Boolean  @default(false)  // System roles can't be deleted
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?

  hospital    Hospital @relation(fields: [hospitalId], references: [id])
  permissions RolePermission[]
  userRoles   UserCustomRole[]

  @@unique([hospitalId, name])
  @@map("custom_roles")
}

// Permissions assigned to a role
model RolePermission {
  id           String   @id @default(uuid())
  roleId       String
  permission   String   // e.g., "patients:read", "patients:write", "appointments:delete"
  createdAt    DateTime @default(now())

  role CustomRole @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permission])
  @@map("role_permissions")
}

// User's custom role assignments (in addition to their base UserRole)
model UserCustomRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  createdBy String?

  user User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  role CustomRole @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_custom_roles")
}

// Audit log for RBAC changes
model RBACauditLog {
  id         String   @id @default(uuid())
  hospitalId String
  action     String   // CREATE_ROLE, UPDATE_ROLE, DELETE_ROLE, ASSIGN_ROLE, REVOKE_ROLE, etc.
  entityType String   // ROLE, PERMISSION, USER_ROLE
  entityId   String
  details    Json?
  performedBy String
  createdAt  DateTime @default(now())

  hospital Hospital @relation(fields: [hospitalId], references: [id])

  @@map("rbac_audit_logs")
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique
  refreshToken String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("sessions")
}

// ==================== MEDICAL STAFF ====================

model Doctor {
  id                String   @id @default(uuid())
  userId            String   @unique
  departmentId      String
  specializationId  String?  // FK to Specialization (nullable for backward compat)
  specialization    String   // Keep for backward compat, will phase out
  qualification     String
  experience        Int      @default(0)
  licenseNumber     String
  consultationFee   Decimal  @db.Decimal(10, 2)
  bio               String?
  availableDays     String[] // ["MONDAY", "TUESDAY", ...]
  slotDuration      Int      @default(30) // minutes
  maxPatientsPerDay Int      @default(30)
  isAvailable       Boolean  @default(true)
  rating            Decimal  @default(0) @db.Decimal(2, 1)
  totalReviews      Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user               User              @relation(fields: [userId], references: [id])
  department         Department        @relation(fields: [departmentId], references: [id])
  specializationRef  Specialization?   @relation(fields: [specializationId], references: [id])
  schedules          DoctorSchedule[]
  slots              DoctorSlot[]
  appointments       Appointment[]
  consultations      Consultation[]
  prescriptions      Prescription[]
  surgeries          Surgery[]
  aiDiagnoses        AIDiagnosis[]
  absences                  DoctorAbsence[]
  noShowLogs                NoShowLog[]
  stageAlerts               StageAlert[]
  consultationParticipants  ConsultationParticipant[]
  referralsMade             ConsultantReferral[] @relation("ReferringDoctor")
  referralsReceived         ConsultantReferral[] @relation("TargetDoctor")
  emergencyPages            EmergencyPage[] @relation("DoctorPages")

  @@map("doctors")
}

model DoctorSchedule {
  id         String   @id @default(uuid())
  doctorId   String
  dayOfWeek  DayOfWeek
  startTime  String   // "09:00"
  endTime    String   // "17:00"
  breakStart String?  // "13:00"
  breakEnd   String?  // "14:00"
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  doctor Doctor @relation(fields: [doctorId], references: [id])

  @@unique([doctorId, dayOfWeek])
  @@map("doctor_schedules")
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model DoctorSlot {
  id            String    @id @default(uuid())
  doctorId      String
  hospitalId    String
  slotDate      DateTime  @db.Date           // The date of the slot
  startTime     String                       // "09:00"
  endTime       String                       // "09:30"
  isAvailable   Boolean   @default(true)     // False when booked
  isBlocked     Boolean   @default(false)    // Doctor manually blocked
  appointmentId String?   @unique            // Link to appointment when booked
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  doctor      Doctor       @relation(fields: [doctorId], references: [id])
  hospital    Hospital     @relation(fields: [hospitalId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])

  @@unique([doctorId, slotDate, startTime])  // One slot per doctor per time
  @@index([doctorId, slotDate, isAvailable])
  @@index([hospitalId, slotDate])
  @@map("doctor_slots")
}

model Nurse {
  id           String   @id @default(uuid())
  userId       String   @unique
  departmentId String
  qualification String
  shift        NurseShift
  licenseNumber String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id])
  department   Department   @relation(fields: [departmentId], references: [id])
  nursingNotes NursingNote[]

  @@map("nurses")
}

enum NurseShift {
  MORNING
  AFTERNOON
  NIGHT
}

// ==================== PATIENT MANAGEMENT ====================

model Patient {
  id               String        @id @default(uuid())
  oderId          String?       @unique
  hospitalId       String
  mrn              String        // Medical Record Number
  firstName        String
  lastName         String
  dateOfBirth      DateTime
  gender           Gender
  bloodGroup       BloodGroup?
  phone            String
  email            String?
  address          String
  city             String
  state            String
  zipCode          String
  emergencyContact String?
  emergencyPhone   String?
  occupation       String?
  maritalStatus    MaritalStatus?
  nationality      String?
  photo            String?
  isActive         Boolean       @default(true)
  status           PatientStatus @default(ACTIVE)
  noShowCount      Int           @default(0)
  lastNoShowAt     DateTime?
  blockedAt        DateTime?
  blockedReason    String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  hospital            Hospital            @relation(fields: [hospitalId], references: [id])
  user                User?               @relation(fields: [oderId], references: [id])
  medicalHistory      MedicalHistory?
  allergies           Allergy[]
  vitals              Vital[]
  appointments        Appointment[]
  consultations       Consultation[]
  prescriptions       Prescription[]
  admissions          Admission[]
  labOrders           LabOrder[]
  imagingOrders       ImagingOrder[]
  invoices            Invoice[]
  insurances          PatientInsurance[]
  aiPredictions       AIPrediction[]
  aiDiagnoses         AIDiagnosis[]
  smartOrders         SmartOrder[]
  clinicalNotes       ClinicalNote[]
  aiScribeSessions    AiScribeSession[]

  // Health & Wellness
  healthDeviceConnections HealthDeviceConnection[]
  healthMetrics           HealthMetric[]
  fitnessActivities       FitnessActivity[]
  fitnessGoals            FitnessGoal[]
  nutritionLogs           NutritionLog[]
  nutritionPlans          NutritionPlan[]
  wellnessGoals           WellnessGoal[]
  wellnessAssessments     WellnessAssessment[]

  // Settings & Preferences
  notificationPreference  PatientNotificationPreference?
  communicationPreference PatientCommunicationPreference?

  // A'mad Precision Health Platform
  healthDataPoints     HealthDataPoint[]
  genomicProfile       GenomicProfile?
  patientConsents      PatientConsent[]
  recommendations      Recommendation[]
  dailyHealthScores    DailyHealthScore[]
  clinicianHealthNotes ClinicianHealthNote[]

  // CRM Module
  crmLeadConversions   CRMLead[]
  crmCommunications    CRMCommunication[]
  crmSurveyResponses   CRMSurveyResponse[]

  // No-Show Tracking
  noShowLogs           NoShowLog[]
  stageAlerts          StageAlert[]

  // Consultant Referrals
  referrals            ConsultantReferral[]

  // Emergency On-Call System
  emergencyPages       EmergencyPage[]

  @@unique([hospitalId, mrn])
  @@unique([hospitalId, phone])
  @@map("patients")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodGroup {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

model MedicalHistory {
  id                  String    @id @default(uuid())
  patientId           String    @unique
  chronicConditions   String[]
  pastSurgeries       String[]
  familyHistory       String[]
  currentMedications  String[]
  immunizations       String[]
  lifestyle           Json?     // smoking, alcohol, exercise
  notes               String?
  // Ongoing treatment (chemotherapy, dialysis, physical therapy, etc.)
  currentTreatment    String?
  // Pregnancy status fields (for females 18-55)
  isPregnant          Boolean?
  expectedDueDate     DateTime?
  lastPregnancyUpdate DateTime? // When pregnancy status was last updated
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])

  @@map("medical_histories")
}

model Allergy {
  id          String       @id @default(uuid())
  patientId   String
  allergen    String
  type        AllergyType
  severity    AllergySeverity
  reaction    String?
  notes       String?
  createdAt   DateTime     @default(now())

  patient Patient @relation(fields: [patientId], references: [id])

  @@map("allergies")
}

enum AllergyType {
  DRUG
  FOOD
  ENVIRONMENTAL
  OTHER
}

enum AllergySeverity {
  MILD
  MODERATE
  SEVERE
  LIFE_THREATENING
}

model Vital {
  id                String   @id @default(uuid())
  patientId         String
  appointmentId     String?  // Optional link to appointment for pre-consultation vitals
  temperature       Decimal? @db.Decimal(4, 1)
  bloodPressureSys  Int?
  bloodPressureDia  Int?
  heartRate         Int?
  respiratoryRate   Int?
  oxygenSaturation  Decimal? @db.Decimal(4, 1)
  weight            Decimal? @db.Decimal(5, 2)
  height            Decimal? @db.Decimal(5, 2)
  bmi               Decimal? @db.Decimal(4, 1)
  bloodSugar        Decimal? @db.Decimal(5, 1)
  painLevel         Int?     // Pain scale 0-10
  notes             String?
  recordedBy        String
  recordedAt        DateTime @default(now())

  // Patient details during vital recording (nurse fills these)
  isPregnant          Boolean?   // For females aged 13-51 only
  expectedDueDate     DateTime?  // If pregnant, optional due date
  currentMedications  Json?      // Array of {name, dosage, frequency}
  currentTreatment    String?    // Ongoing treatment details

  patient     Patient      @relation(fields: [patientId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])

  @@map("vitals")
}

model PatientInsurance {
  id              String   @id @default(uuid())
  patientId       String
  providerName    String
  policyNumber    String
  groupNumber     String?
  subscriberName  String
  subscriberId    String
  relationship    String
  effectiveDate   DateTime
  expiryDate      DateTime?
  coverageType    String
  copay           Decimal? @db.Decimal(10, 2)
  deductible      Decimal? @db.Decimal(10, 2)
  isPrimary       Boolean  @default(true)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])

  @@map("patient_insurances")
}

// ==================== APPOINTMENTS ====================

model Appointment {
  id              String            @id @default(uuid())
  hospitalId      String
  patientId       String
  doctorId        String
  appointmentDate DateTime
  startTime       String
  endTime         String
  type            AppointmentType
  status          AppointmentStatus @default(SCHEDULED)
  reason          String?
  notes           String?
  isFollowUp      Boolean           @default(false)
  parentAppointmentId String?
  tokenNumber     Int?
  checkedInAt     DateTime?
  vitalsRecordedAt DateTime?        // Timestamp when pre-consultation vitals were recorded
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  hospital       Hospital      @relation(fields: [hospitalId], references: [id])
  patient        Patient       @relation(fields: [patientId], references: [id])
  doctor         Doctor        @relation(fields: [doctorId], references: [id])
  consultation   Consultation?
  clinicalNotes  ClinicalNote[] @relation("ClinicalNoteAppointment")
  vitals         Vital[]       // Pre-consultation vitals recorded for this appointment
  slot           DoctorSlot?
  noShowLogs     NoShowLog[]
  stageAlerts    StageAlert[]
  sourceReferrals    ConsultantReferral[] @relation("SourceAppointment")
  referralAppointment ConsultantReferral? @relation("ReferralAppointment")

  @@map("appointments")
}

enum AppointmentType {
  CONSULTATION
  FOLLOW_UP
  EMERGENCY
  TELEMEDICINE
  PROCEDURE
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum ConsultationStatus {
  STARTED       // Doctor opened consultation
  IN_PROGRESS   // Doctor actively entering data
  COMPLETED     // Doctor finished and signed off
  ABANDONED     // Doctor left without completing
}

enum PatientStatus {
  ACTIVE        // Normal patient
  FLAGGED       // Has issues but can book
  BLOCKED       // Cannot book appointments (repeat no-shows)
  SUSPENDED     // Temporarily suspended
}

// ==================== NO-SHOW TRACKING ====================

enum NoShowReason {
  AUTO_TIMEOUT        // Automatic - exceeded slot interval
  MANUAL_STAFF        // Manually marked by staff
  MANUAL_DOCTOR       // Manually marked by doctor
  PATIENT_CALLED      // Patient called to cancel late
}

enum StageAlertType {
  NO_VITALS           // Checked in but no vitals recorded
  NO_DOCTOR           // Vitals done but doctor not seen
  WAITING_TOO_LONG    // General long wait alert
}

enum StageAlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
}

model NoShowLog {
  id              String       @id @default(uuid())
  hospitalId      String
  appointmentId   String
  patientId       String
  doctorId        String
  reason          NoShowReason
  slotTime        String       // Original slot time (HH:MM)
  timeoutMinutes  Int          // Doctor's slot interval used
  triggeredAt     DateTime     @default(now())
  slotReleased    Boolean      @default(false)
  slotReleasedAt  DateTime?
  notificationSent Boolean     @default(false)
  notes           String?
  createdBy       String?      // null for auto, userId for manual

  // Relations
  hospital    Hospital    @relation(fields: [hospitalId], references: [id])
  appointment Appointment @relation(fields: [appointmentId], references: [id])
  patient     Patient     @relation(fields: [patientId], references: [id])
  doctor      Doctor      @relation(fields: [doctorId], references: [id])

  @@index([hospitalId, triggeredAt])
  @@index([appointmentId])
  @@index([patientId])
  @@map("no_show_logs")
}

model StageAlert {
  id              String           @id @default(uuid())
  hospitalId      String
  appointmentId   String
  patientId       String
  doctorId        String
  alertType       StageAlertType
  status          StageAlertStatus @default(ACTIVE)
  message         String
  triggeredAt     DateTime         @default(now())
  acknowledgedAt  DateTime?
  acknowledgedBy  String?
  resolvedAt      DateTime?
  resolvedBy      String?

  // Relations
  hospital    Hospital    @relation(fields: [hospitalId], references: [id])
  appointment Appointment @relation(fields: [appointmentId], references: [id])
  patient     Patient     @relation(fields: [patientId], references: [id])
  doctor      Doctor      @relation(fields: [doctorId], references: [id])

  @@index([hospitalId, status])
  @@index([appointmentId])
  @@index([doctorId, status])
  @@map("stage_alerts")
}

// Cron Job Health Tracking
model CronJobRun {
  id            String   @id @default(uuid())
  jobName       String                     // "NO_SHOW_CHECK", "SLOT_GENERATION", etc.
  status        CronJobStatus @default(RUNNING)
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  durationMs    Int?
  itemsProcessed Int     @default(0)       // Number of items processed
  errorMessage  String?                    // Error details if failed
  metadata      Json?                      // Additional run details

  @@index([jobName, startedAt])
  @@index([status])
  @@map("cron_job_runs")
}

enum CronJobStatus {
  RUNNING
  COMPLETED
  FAILED
}

// ==================== EMERGENCY ON-CALL SYSTEM ====================

model EmergencyPage {
  id            String   @id @default(uuid())
  hospitalId    String
  doctorId      String
  patientId     String?  // optional - which patient needs attention
  pagedBy       String   // userId who sent the page
  urgency       PageUrgency
  message       String
  status        PageStatus  @default(PENDING)
  responseTime  DateTime?   // when doctor responded
  arrivedAt     DateTime?   // when doctor arrived
  declineReason String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  hospital      Hospital @relation(fields: [hospitalId], references: [id])
  doctor        Doctor   @relation("DoctorPages", fields: [doctorId], references: [id])
  patient       Patient? @relation(fields: [patientId], references: [id])
  pagedByUser   User     @relation("UserPages", fields: [pagedBy], references: [id])

  @@index([hospitalId, status])
  @@index([doctorId, status])
  @@map("emergency_pages")
}

enum PageUrgency {
  STAT
  URGENT
  ROUTINE
}

enum PageStatus {
  PENDING
  ACKNOWLEDGED
  EN_ROUTE
  ARRIVED
  DECLINED
  EXPIRED
}

enum DoctorOnCallStatus {
  AVAILABLE
  IN_SURGERY
  ON_BREAK
  RESPONDING
}

// ==================== CLINICAL ====================

model Consultation {
  id                String             @id @default(uuid())
  appointmentId     String             @unique
  patientId         String
  doctorId          String
  chiefComplaint    String
  historyOfIllness  String?
  examination       String?
  diagnosis         String[]
  icdCodes          String[]
  treatmentPlan     String?
  advice            String?
  followUpDate      DateTime?
  notes             String?
  status            ConsultationStatus @default(STARTED)
  startedAt         DateTime           @default(now())
  completedAt       DateTime?
  abandonedAt       DateTime?
  completedBy       String?            // Doctor who completed
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  appointment    Appointment               @relation(fields: [appointmentId], references: [id])
  patient        Patient                   @relation(fields: [patientId], references: [id])
  doctor         Doctor                    @relation(fields: [doctorId], references: [id])
  prescriptions  Prescription[]
  labOrders      LabOrder[]
  imagingOrders  ImagingOrder[]
  clinicalNotes  ClinicalNote[]
  participants   ConsultationParticipant[] // Multi-doctor support

  // Insurance Coding
  consultationDiagnoses  ConsultationDiagnosis[]
  consultationProcedures ConsultationProcedure[]

  // Consultant Referrals
  referrals              ConsultantReferral[]

  @@map("consultations")
}

model Prescription {
  id             String             @id @default(uuid())
  consultationId String?
  patientId      String
  doctorId       String
  admissionId    String?
  prescriptionDate DateTime         @default(now())
  status         PrescriptionStatus @default(ACTIVE)
  notes          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  // Relations
  consultation    Consultation?        @relation(fields: [consultationId], references: [id])
  patient         Patient              @relation(fields: [patientId], references: [id])
  doctor          Doctor               @relation(fields: [doctorId], references: [id])
  admission       Admission?           @relation(fields: [admissionId], references: [id])
  medications     PrescriptionMedication[]

  @@map("prescriptions")
}

enum PrescriptionStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model PrescriptionMedication {
  id              String   @id @default(uuid())
  prescriptionId  String
  drugId          String?
  drugName        String
  dosage          String
  frequency       String
  duration        String
  quantity        Int
  route           String   // oral, injection, topical
  instructions    String?
  beforeAfterFood String?
  isDispensed     Boolean  @default(false)
  dispensedAt     DateTime?
  dispensedBy     String?

  prescription Prescription @relation(fields: [prescriptionId], references: [id])
  drug         Drug?        @relation(fields: [drugId], references: [id])

  @@map("prescription_medications")
}

// ==================== INPATIENT (IPD) ====================

model Bed {
  id           String     @id @default(uuid())
  hospitalId   String
  departmentId String
  wardId       String
  bedNumber    String
  bedType      BedType
  status       BedStatus  @default(AVAILABLE)
  dailyRate    Decimal    @db.Decimal(10, 2)
  features     String[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  hospital   Hospital    @relation(fields: [hospitalId], references: [id])
  department Department  @relation(fields: [departmentId], references: [id])
  ward       Ward        @relation(fields: [wardId], references: [id])
  admissions Admission[]

  @@unique([hospitalId, bedNumber])
  @@map("beds")
}

model Ward {
  id           String   @id @default(uuid())
  name         String
  floor        Int
  capacity     Int
  type         WardType
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  beds Bed[]

  @@map("wards")
}

enum WardType {
  GENERAL
  PRIVATE
  SEMI_PRIVATE
  ICU
  NICU
  PICU
  CCU
  ISOLATION
}

enum BedType {
  STANDARD
  ICU
  ELECTRIC
  PEDIATRIC
  BARIATRIC
}

enum BedStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  MAINTENANCE
  CLEANING
}

model Admission {
  id                String          @id @default(uuid())
  hospitalId        String
  patientId         String
  bedId             String
  admissionDate     DateTime
  dischargeDate     DateTime?
  admissionType     AdmissionType
  admittingDoctorId String
  status            AdmissionStatus @default(ADMITTED)
  chiefComplaint    String
  diagnosis         String[]
  icdCodes          String[]
  treatmentPlan     String?
  estimatedDays     Int?
  notes             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  hospital        Hospital          @relation(fields: [hospitalId], references: [id])
  patient         Patient           @relation(fields: [patientId], references: [id])
  bed             Bed               @relation(fields: [bedId], references: [id])
  nursingNotes    NursingNote[]
  prescriptions   Prescription[]
  surgeries       Surgery[]
  dischargeSummary DischargeSummary?
  dischargeCoding  DischargeCoding?

  @@map("admissions")
}

enum AdmissionType {
  EMERGENCY
  ELECTIVE
  TRANSFER
  MATERNITY
}

enum AdmissionStatus {
  ADMITTED
  DISCHARGED
  TRANSFERRED
  DECEASED
  ABSCONDED
}

model NursingNote {
  id           String   @id @default(uuid())
  admissionId  String
  nurseId      String
  noteType     String
  content      String
  vitals       Json?
  createdAt    DateTime @default(now())

  admission Admission @relation(fields: [admissionId], references: [id])
  nurse     Nurse     @relation(fields: [nurseId], references: [id])

  @@map("nursing_notes")
}

model DischargeSummary {
  id                     String   @id @default(uuid())
  admissionId            String   @unique
  dischargeDate          DateTime
  dischargeType          String
  finalDiagnosis         String[]
  proceduresPerformed    String[]
  conditionAtDischarge   String
  medicationsOnDischarge String[]
  followUpInstructions   String?
  followUpDate           DateTime?
  dietaryInstructions    String?
  activityRestrictions   String?
  warningSignsToWatch    String[]
  preparedBy             String
  createdAt              DateTime @default(now())

  admission Admission @relation(fields: [admissionId], references: [id])

  @@map("discharge_summaries")
}

// ==================== SURGERY / OPERATION THEATRE ====================

model Surgery {
  id               String        @id @default(uuid())
  admissionId      String
  patientId        String
  surgeonId        String
  surgeryType      String
  procedureName    String
  cptCode          String?
  scheduledDate    DateTime
  actualStartTime  DateTime?
  actualEndTime    DateTime?
  status           SurgeryStatus @default(SCHEDULED)
  operationTheatre String
  anesthesiaType   String?
  preOpDiagnosis   String
  postOpDiagnosis  String?
  findings         String?
  complications    String?
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  admission Admission @relation(fields: [admissionId], references: [id])
  surgeon   Doctor    @relation(fields: [surgeonId], references: [id])

  @@map("surgeries")
}

enum SurgeryStatus {
  SCHEDULED
  IN_PREPARATION
  IN_PROGRESS
  COMPLETED
  CANCELLED
  POSTPONED
}

// ==================== LABORATORY ====================

model LabTest {
  id             String   @id @default(uuid())
  name           String
  code           String   @unique
  category       String
  description    String?
  sampleType     String
  normalRange    String?
  unit           String?
  price          Decimal  @db.Decimal(10, 2)
  turnaroundTime Int      // hours
  instructions   String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  labOrderTests LabOrderTest[]

  @@map("lab_tests")
}

model LabOrder {
  id             String        @id @default(uuid())
  hospitalId     String
  patientId      String
  consultationId String?
  orderNumber    String        @unique
  orderedBy      String
  priority       LabPriority   @default(ROUTINE)
  status         LabOrderStatus @default(ORDERED)
  clinicalNotes  String?
  specialInstructions String?
  orderedAt      DateTime      @default(now())
  collectedAt    DateTime?
  receivedAt     DateTime?     // When lab received samples
  completedAt    DateTime?
  verifiedAt     DateTime?     // When pathologist verified
  verifiedBy     String?       // Pathologist userId
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  hospital       Hospital       @relation(fields: [hospitalId], references: [id])
  patient        Patient        @relation(fields: [patientId], references: [id])
  consultation   Consultation?  @relation(fields: [consultationId], references: [id])
  orderedByUser  User           @relation("LabOrderOrderedBy", fields: [orderedBy], references: [id])
  verifiedByUser User?          @relation("LabOrderVerifiedBy", fields: [verifiedBy], references: [id])
  tests          LabOrderTest[]
  samples        LabSample[]

  @@map("lab_orders")
}

enum LabPriority {
  STAT
  URGENT
  ROUTINE
}

enum LabOrderStatus {
  ORDERED
  SAMPLE_COLLECTED
  RECEIVED            // Lab received the sample
  IN_PROGRESS
  RESULTED            // Results entered, pending verification
  VERIFIED            // Pathologist verified
  COMPLETED
  CANCELLED
  PARTIALLY_COMPLETED // Some tests done, some cancelled/pending
}

model LabOrderTest {
  id           String          @id @default(uuid())
  labOrderId   String
  labTestId    String
  status       LabTestStatus   @default(PENDING)
  result       String?
  resultValue  Decimal?        @db.Decimal(10, 3)
  unit         String?
  normalRange  String?
  isAbnormal   Boolean         @default(false)
  isCritical   Boolean         @default(false)
  comments     String?
  performedBy  String?
  verifiedBy   String?
  performedAt  DateTime?
  verifiedAt   DateTime?

  // File upload fields
  attachmentUrl      String?  // S3/MinIO URL for uploaded file
  attachmentType     String?  // MIME type (application/pdf, image/jpeg, etc.)
  extractedByAI      Boolean  @default(false)
  aiConfidence       String?  // LOW, MEDIUM, HIGH
  rawExtractedText   String?  @db.Text

  labOrder LabOrder @relation(fields: [labOrderId], references: [id])
  labTest  LabTest  @relation(fields: [labTestId], references: [id])

  @@map("lab_order_tests")
}

enum LabTestStatus {
  PENDING
  IN_PROGRESS
  RESULTED        // Result entered, awaiting verification
  VERIFIED        // Pathologist verified
  COMPLETED
  CANCELLED
  RERUN_REQUESTED // Pathologist requested re-run
}

model LabSample {
  id                String           @id @default(uuid())
  labOrderId        String
  barcode           String           @unique
  sampleType        SampleType
  sampleVolume      Decimal?         @db.Decimal(6, 2) // in mL
  sampleCondition   SampleCondition  @default(ADEQUATE)
  specialHandling   String[]         // ["REFRIGERATE", "LIGHT_SENSITIVE", "TIMED"]
  collectedBy       String
  collectionTime    DateTime
  receivedBy        String?
  receivedAt        DateTime?
  status            SampleStatus     @default(COLLECTED)
  isVerified        Boolean          @default(false)
  verifiedBy        String?
  verifiedAt        DateTime?
  rejectionReason   String?
  requiresColdChain Boolean          @default(false)
  notes             String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Relations
  labOrder         LabOrder             @relation(fields: [labOrderId], references: [id])
  collectedByUser  User                 @relation("SampleCollectedBy", fields: [collectedBy], references: [id])
  receivedByUser   User?                @relation("SampleReceivedBy", fields: [receivedBy], references: [id])
  verifiedByUser   User?                @relation("SampleVerifiedBy", fields: [verifiedBy], references: [id])
  custodyLog       SampleCustodyLog[]

  @@map("lab_samples")
}

enum SampleType {
  BLOOD
  SERUM
  PLASMA
  URINE
  STOOL
  SWAB
  TISSUE
  CSF
  SPUTUM
  FLUID
  OTHER
}

enum SampleCondition {
  ADEQUATE
  HEMOLYZED
  LIPEMIC
  CLOTTED
  INSUFFICIENT
  CONTAMINATED
}

enum SampleStatus {
  COLLECTED
  IN_TRANSIT
  RECEIVED
  PROCESSING
  ANALYZED
  STORED
  DISPOSED
  REJECTED
}

model SampleCustodyLog {
  id            String   @id @default(uuid())
  sampleId      String
  status        String
  location      String
  handledBy     String
  temperature   Decimal? @db.Decimal(4, 1) // for cold chain
  notes         String?
  timestamp     DateTime @default(now())

  // Relations
  sample        LabSample @relation(fields: [sampleId], references: [id])
  handler       User      @relation(fields: [handledBy], references: [id])

  @@map("sample_custody_logs")
}

// ==================== RADIOLOGY ====================

model ImagingOrder {
  id              String              @id @default(uuid())
  hospitalId      String
  patientId       String
  consultationId  String?
  orderNumber     String              @unique
  modalityType    ModalityType
  bodyPart        String
  priority        ImagingPriority     @default(ROUTINE)
  status          ImagingOrderStatus  @default(ORDERED)
  clinicalHistory String?
  orderedBy       String
  scheduledDate   DateTime?
  performedDate   DateTime?
  notes           String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  hospital        Hospital              @relation(fields: [hospitalId], references: [id])
  patient         Patient               @relation(fields: [patientId], references: [id])
  consultation    Consultation?         @relation(fields: [consultationId], references: [id])
  study           ImagingStudy?
  aiAnalysis      AIImageAnalysis?

  @@map("imaging_orders")
}

enum ModalityType {
  XRAY
  CT
  MRI
  ULTRASOUND
  MAMMOGRAPHY
  PET
  FLUOROSCOPY
}

enum ImagingPriority {
  STAT
  URGENT
  ROUTINE
}

enum ImagingOrderStatus {
  ORDERED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model ImagingStudy {
  id              String   @id @default(uuid())
  orderId         String   @unique
  studyInstanceUid String  @unique
  accessionNumber String
  studyDate       DateTime
  studyDescription String?
  numberOfSeries  Int      @default(0)
  numberOfImages  Int      @default(0)
  modality        String
  bodyPart        String
  storageLocation String   // S3 path
  findings        String?
  impression      String?
  radiologistId   String?
  reportedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  order ImagingOrder @relation(fields: [orderId], references: [id])

  @@map("imaging_studies")
}

// ==================== PHARMACY ====================

model Drug {
  id               String   @id @default(uuid())
  name             String
  genericName      String
  brandName        String?
  code             String   @unique
  category         String
  dosageForm       String   // tablet, capsule, syrup, injection
  strength         String
  manufacturer     String?
  batchNumber      String?
  expiryDate       DateTime?
  price            Decimal  @db.Decimal(10, 2)
  reorderLevel     Int      @default(10)
  isControlled     Boolean  @default(false)
  requiresPrescription Boolean @default(true)
  sideEffects      String[]
  contraindications String[]
  interactions     String[]
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  inventory       DrugInventory[]
  prescriptions   PrescriptionMedication[]

  @@map("drugs")
}

model DrugInventory {
  id          String   @id @default(uuid())
  drugId      String
  batchNumber String
  quantity    Int
  expiryDate  DateTime
  location    String   // store, pharmacy counter
  costPrice   Decimal  @db.Decimal(10, 2)
  sellingPrice Decimal @db.Decimal(10, 2)
  supplierId  String?
  receivedDate DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  drug     Drug      @relation(fields: [drugId], references: [id])
  supplier Supplier? @relation(fields: [supplierId], references: [id])

  @@map("drug_inventory")
}

// ==================== INVENTORY ====================

model InventoryItem {
  id           String   @id @default(uuid())
  hospitalId   String
  name         String
  code         String
  category     String
  description  String?
  unit         String
  quantity     Int      @default(0)
  minQuantity  Int      @default(0)
  maxQuantity  Int?
  reorderLevel Int      @default(10)
  location     String?
  costPrice    Decimal  @db.Decimal(10, 2)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  hospital Hospital @relation(fields: [hospitalId], references: [id])

  @@unique([hospitalId, code])
  @@map("inventory_items")
}

// ==================== BILLING ====================

model Invoice {
  id              String        @id @default(uuid())
  hospitalId      String
  patientId       String
  invoiceNumber   String        @unique
  invoiceDate     DateTime      @default(now())
  dueDate         DateTime?
  status          InvoiceStatus @default(PENDING)
  subtotal        Decimal       @db.Decimal(10, 2)
  discount        Decimal       @default(0) @db.Decimal(10, 2)
  tax             Decimal       @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal       @db.Decimal(10, 2)
  paidAmount      Decimal       @default(0) @db.Decimal(10, 2)
  balanceAmount   Decimal       @db.Decimal(10, 2)
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  hospital   Hospital       @relation(fields: [hospitalId], references: [id])
  patient    Patient        @relation(fields: [patientId], references: [id])
  items      InvoiceItem[]
  payments   Payment[]
  claims     InsuranceClaim[]

  @@map("invoices")
}

enum InvoiceStatus {
  PENDING
  PARTIALLY_PAID
  PAID
  CANCELLED
  REFUNDED
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  description String
  category    String
  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(10, 2)
  discount    Decimal  @default(0) @db.Decimal(10, 2)
  totalPrice  Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@map("invoice_items")
}

model Payment {
  id            String        @id @default(uuid())
  invoiceId     String
  paymentDate   DateTime      @default(now())
  amount        Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  referenceNumber String?
  notes         String?
  receivedBy    String
  createdAt     DateTime      @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@map("payments")
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  UPI
  NET_BANKING
  INSURANCE
  CHEQUE
}

model InsuranceClaim {
  id              String      @id @default(uuid())
  invoiceId       String
  claimNumber     String      @unique
  insuranceProvider String
  policyNumber    String
  claimAmount     Decimal     @db.Decimal(10, 2)
  approvedAmount  Decimal?    @db.Decimal(10, 2)
  status          ClaimStatus @default(SUBMITTED)
  submittedAt     DateTime    @default(now())
  processedAt     DateTime?
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@map("insurance_claims")
}

enum ClaimStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  PARTIALLY_APPROVED
  REJECTED
  PAID
}

// ==================== AI MODULES ====================

model AIDiagnosis {
  id               String   @id @default(uuid())
  patientId        String
  doctorId         String?
  symptoms         String[]
  suggestedDiagnoses Json   // [{icd10: "", name: "", confidence: 0.95}]
  recommendedTests String[]
  treatmentSuggestions String[]
  drugInteractionWarnings String[]
  riskFactors      String[]
  confidence       Decimal  @db.Decimal(3, 2)
  modelVersion     String
  isAccepted       Boolean?
  feedback         String?
  createdAt        DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id])
  doctor  Doctor? @relation(fields: [doctorId], references: [id])

  @@map("ai_diagnoses")
}

model AIPrediction {
  id              String         @id @default(uuid())
  patientId       String
  predictionType  PredictionType
  riskScore       Decimal        @db.Decimal(3, 2)
  riskLevel       RiskLevel
  factors         Json           // Contributing factors
  recommendations String[]
  timeframe       String?        // "30 days", "90 days"
  modelVersion    String
  createdAt       DateTime       @default(now())

  patient Patient @relation(fields: [patientId], references: [id])

  @@map("ai_predictions")
}

enum PredictionType {
  READMISSION
  LENGTH_OF_STAY
  MORTALITY
  DISEASE_PROGRESSION
  NO_SHOW
  DETERIORATION
}

enum RiskLevel {
  LOW
  MODERATE
  HIGH
  CRITICAL
}

model AIImageAnalysis {
  id               String   @id @default(uuid())
  imagingOrderId   String   @unique
  findings         Json     // [{region: "", finding: "", confidence: 0.95}]
  impression       String?
  heatmapUrl       String?
  abnormalityDetected Boolean @default(false)
  confidence       Decimal  @db.Decimal(3, 2)
  modelVersion     String
  isReviewed       Boolean  @default(false)
  reviewedBy       String?
  reviewedAt       DateTime?
  feedback         String?
  createdAt        DateTime @default(now())

  imagingOrder ImagingOrder @relation(fields: [imagingOrderId], references: [id])

  @@map("ai_image_analyses")
}

// ==================== SYSTEM ====================

model AuditLog {
  id          String   @id @default(uuid())
  hospitalId  String
  userId      String?
  action      String
  entityType  String
  entityId    String?
  oldValues   Json?
  newValues   Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  hospital Hospital @relation(fields: [hospitalId], references: [id])
  user     User?    @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  data      Json?
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
}

enum NotificationType {
  APPOINTMENT
  LAB_RESULT
  PRESCRIPTION
  ALERT
  SYSTEM
  AI_INSIGHT
}

// ==================== HR & STAFF MANAGEMENT ====================

model Employee {
  id                String         @id @default(uuid())
  hospitalId        String
  oderId           String?        @unique // Link to User if applicable
  employeeCode      String
  firstName         String
  lastName          String
  email             String
  phone             String
  dateOfBirth       DateTime
  gender            Gender
  address           String
  city              String
  state             String
  zipCode           String
  photo             String?

  // Employment Details
  departmentId      String?
  designation       String
  employeeType      EmployeeType
  employmentStatus  EmploymentStatus @default(ACTIVE)
  joiningDate       DateTime
  confirmationDate  DateTime?
  resignationDate   DateTime?
  lastWorkingDate   DateTime?
  reportingTo       String?        // Manager's employee ID

  // Compensation
  basicSalary       Decimal        @db.Decimal(12, 2)
  currency          String         @default("USD")
  payFrequency      PayFrequency   @default(MONTHLY)
  bankName          String?
  bankAccountNumber String?
  bankIfscCode      String?
  panNumber         String?
  pfNumber          String?
  esiNumber         String?

  // Professional
  qualification     String?
  specialization    String?
  experience        Int            @default(0)
  licenseNumber     String?
  licenseExpiry     DateTime?

  // Shift & Attendance
  shiftId           String?

  // Emergency Contact
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactRelation String?

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  hospital          Hospital       @relation(fields: [hospitalId], references: [id])
  user              User?          @relation(fields: [oderId], references: [id])
  shift             Shift?         @relation(fields: [shiftId], references: [id])
  documents         EmployeeDocument[]
  attendance        Attendance[]
  leaveRequests     LeaveRequest[]
  leaveBalances     LeaveBalance[]
  payrolls          Payroll[]
  performanceReviews PerformanceReview[]
  trainings         EmployeeTraining[]
  housekeepingTasks HousekeepingTask[] @relation("AssignedTasks")
  supervisedTasks   HousekeepingTask[] @relation("SupervisedTasks")
  qualityAudits     QualityAudit[]

  @@unique([hospitalId, employeeCode])
  @@map("employees")
}

enum EmployeeType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERN
  CONSULTANT
  TEMPORARY
}

enum EmploymentStatus {
  ACTIVE
  ON_LEAVE
  SUSPENDED
  RESIGNED
  TERMINATED
  RETIRED
  DECEASED
}

enum PayFrequency {
  WEEKLY
  BI_WEEKLY
  MONTHLY
}

model EmployeeDocument {
  id           String       @id @default(uuid())
  employeeId   String
  documentType DocumentType
  documentName String
  documentNumber String?
  fileUrl      String
  issueDate    DateTime?
  expiryDate   DateTime?
  isVerified   Boolean      @default(false)
  verifiedBy   String?
  verifiedAt   DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id])

  @@map("employee_documents")
}

enum DocumentType {
  ID_PROOF
  ADDRESS_PROOF
  PHOTO
  RESUME
  OFFER_LETTER
  CONTRACT
  DEGREE_CERTIFICATE
  EXPERIENCE_LETTER
  LICENSE
  CERTIFICATION
  PAN_CARD
  PASSPORT
  VISA
  MEDICAL_CERTIFICATE
  POLICE_CLEARANCE
  OTHER
}

model Shift {
  id          String    @id @default(uuid())
  hospitalId  String
  name        String
  code        String
  startTime   String    // "09:00"
  endTime     String    // "17:00"
  breakStart  String?   // "13:00"
  breakEnd    String?   // "14:00"
  workingHours Decimal  @db.Decimal(4, 2)
  isNightShift Boolean  @default(false)
  isActive    Boolean   @default(true)
  color       String?   // For UI display
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  employees   Employee[]
  schedules   ShiftSchedule[]

  @@unique([hospitalId, code])
  @@map("shifts")
}

model ShiftSchedule {
  id          String    @id @default(uuid())
  shiftId     String
  employeeId  String
  date        DateTime
  status      ShiftStatus @default(SCHEDULED)
  actualStart DateTime?
  actualEnd   DateTime?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  shift       Shift     @relation(fields: [shiftId], references: [id])

  @@map("shift_schedules")
}

enum ShiftStatus {
  SCHEDULED
  STARTED
  COMPLETED
  MISSED
  SWAPPED
}

model Attendance {
  id            String           @id @default(uuid())
  employeeId    String
  date          DateTime
  checkIn       DateTime?
  checkOut      DateTime?
  checkInLocation String?        // GPS coordinates
  checkOutLocation String?
  status        AttendanceStatus @default(PRESENT)
  workingHours  Decimal?         @db.Decimal(4, 2)
  overtime      Decimal?         @db.Decimal(4, 2)
  lateMinutes   Int?
  earlyLeaveMinutes Int?
  remarks       String?
  approvedBy    String?
  biometricId   String?
  ipAddress     String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, date])
  @@map("attendance")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LATE
  ON_LEAVE
  HOLIDAY
  WEEK_OFF
  WORK_FROM_HOME
}

model LeaveType {
  id              String    @id @default(uuid())
  hospitalId      String
  name            String
  code            String
  description     String?
  defaultDays     Int       @default(0)
  carryForward    Boolean   @default(false)
  maxCarryForward Int?
  isPaid          Boolean   @default(true)
  requiresApproval Boolean  @default(true)
  minNoticeDays   Int       @default(0)
  maxConsecutiveDays Int?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  leaveBalances  LeaveBalance[]
  leaveRequests  LeaveRequest[]

  @@unique([hospitalId, code])
  @@map("leave_types")
}

model LeaveBalance {
  id            String    @id @default(uuid())
  employeeId    String
  leaveTypeId   String
  year          Int
  entitled      Decimal   @db.Decimal(5, 2)
  taken         Decimal   @default(0) @db.Decimal(5, 2)
  pending       Decimal   @default(0) @db.Decimal(5, 2)
  balance       Decimal   @db.Decimal(5, 2)
  carryForwarded Decimal  @default(0) @db.Decimal(5, 2)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  employee      Employee   @relation(fields: [employeeId], references: [id])
  leaveType     LeaveType  @relation(fields: [leaveTypeId], references: [id])

  @@unique([employeeId, leaveTypeId, year])
  @@map("leave_balances")
}

model LeaveRequest {
  id            String       @id @default(uuid())
  employeeId    String
  leaveTypeId   String
  startDate     DateTime
  endDate       DateTime
  days          Decimal      @db.Decimal(5, 2)
  reason        String
  status        LeaveStatus  @default(PENDING)
  appliedAt     DateTime     @default(now())
  approvedBy    String?
  approvedAt    DateTime?
  rejectionReason String?
  cancelledAt   DateTime?
  attachmentUrl String?
  isEmergency   Boolean      @default(false)
  contactNumber String?
  handoverTo    String?
  handoverNotes String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  employee      Employee   @relation(fields: [employeeId], references: [id])
  leaveType     LeaveType  @relation(fields: [leaveTypeId], references: [id])

  @@map("leave_requests")
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  WITHDRAWN
}

model Payroll {
  id              String        @id @default(uuid())
  employeeId      String
  month           Int
  year            Int

  // Earnings
  basicSalary     Decimal       @db.Decimal(12, 2)
  hra             Decimal       @default(0) @db.Decimal(12, 2)
  conveyance      Decimal       @default(0) @db.Decimal(12, 2)
  medicalAllowance Decimal      @default(0) @db.Decimal(12, 2)
  specialAllowance Decimal      @default(0) @db.Decimal(12, 2)
  overtime        Decimal       @default(0) @db.Decimal(12, 2)
  bonus           Decimal       @default(0) @db.Decimal(12, 2)
  otherEarnings   Decimal       @default(0) @db.Decimal(12, 2)
  grossEarnings   Decimal       @db.Decimal(12, 2)

  // Deductions
  pfEmployee      Decimal       @default(0) @db.Decimal(12, 2)
  pfEmployer      Decimal       @default(0) @db.Decimal(12, 2)
  esi             Decimal       @default(0) @db.Decimal(12, 2)
  professionalTax Decimal       @default(0) @db.Decimal(12, 2)
  tds             Decimal       @default(0) @db.Decimal(12, 2)
  loanDeduction   Decimal       @default(0) @db.Decimal(12, 2)
  otherDeductions Decimal       @default(0) @db.Decimal(12, 2)
  totalDeductions Decimal       @db.Decimal(12, 2)

  // Net
  netSalary       Decimal       @db.Decimal(12, 2)

  // Working Days
  totalWorkingDays Int
  daysWorked      Int
  leavesTaken     Int           @default(0)
  lopDays         Int           @default(0)

  status          PayrollStatus @default(DRAFT)
  processedBy     String?
  processedAt     DateTime?
  paidAt          DateTime?
  paymentMode     String?
  transactionId   String?
  remarks         String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id])
  components PayrollComponent[]

  @@unique([employeeId, month, year])
  @@map("payrolls")
}

enum PayrollStatus {
  DRAFT
  PROCESSING
  PROCESSED
  APPROVED
  PAID
  ON_HOLD
  CANCELLED
}

model PayrollComponent {
  id          String    @id @default(uuid())
  payrollId   String
  name        String
  type        PayrollComponentType
  amount      Decimal   @db.Decimal(12, 2)
  description String?
  createdAt   DateTime  @default(now())

  payroll Payroll @relation(fields: [payrollId], references: [id])

  @@map("payroll_components")
}

enum PayrollComponentType {
  EARNING
  DEDUCTION
  REIMBURSEMENT
}

model PerformanceReview {
  id              String    @id @default(uuid())
  employeeId      String
  reviewerId      String
  reviewPeriodStart DateTime
  reviewPeriodEnd DateTime
  reviewDate      DateTime

  // Scores (1-5)
  workQuality     Int?
  productivity    Int?
  attendance      Int?
  teamwork        Int?
  communication   Int?
  initiative      Int?
  leadership      Int?
  technicalSkills Int?
  overallRating   Decimal   @db.Decimal(3, 2)

  strengths       String[]
  improvements    String[]
  goals           String[]
  employeeComments String?
  reviewerComments String?

  status          ReviewStatus @default(DRAFT)
  acknowledgedAt  DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id])

  @@map("performance_reviews")
}

enum ReviewStatus {
  DRAFT
  SUBMITTED
  ACKNOWLEDGED
  COMPLETED
}

model EmployeeTraining {
  id              String    @id @default(uuid())
  employeeId      String
  trainingName    String
  trainingType    String
  provider        String?
  startDate       DateTime
  endDate         DateTime?
  duration        Int?      // hours
  status          TrainingStatus @default(SCHEDULED)
  score           Decimal?  @db.Decimal(5, 2)
  certificateUrl  String?
  expiryDate      DateTime?
  cost            Decimal?  @db.Decimal(10, 2)
  remarks         String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id])

  @@map("employee_trainings")
}

enum TrainingStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

// ==================== HOUSEKEEPING ====================

model HousekeepingZone {
  id          String    @id @default(uuid())
  hospitalId  String
  name        String
  code        String
  floor       String
  building    String?
  description String?
  roomCount   Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tasks       HousekeepingTask[]
  schedules   CleaningSchedule[]

  @@unique([hospitalId, code])
  @@map("housekeeping_zones")
}

model HousekeepingTask {
  id              String             @id @default(uuid())
  hospitalId      String
  zoneId          String
  roomNumber      String?
  bedId           String?
  taskType        HousekeepingTaskType
  priority        TaskPriority       @default(NORMAL)
  status          HousekeepingStatus @default(PENDING)

  // Assignment
  assignedTo      String?
  assignedAt      DateTime?
  supervisorId    String?

  // Timing
  scheduledStart  DateTime?
  scheduledEnd    DateTime?
  actualStart     DateTime?
  actualEnd       DateTime?
  estimatedMinutes Int               @default(30)

  // Details
  description     String?
  specialInstructions String?
  infectionControl Boolean           @default(false)
  checklistCompleted Boolean         @default(false)

  // Quality
  qualityScore    Int?              // 1-10
  verifiedBy      String?
  verifiedAt      DateTime?

  // Patient discharge related
  isDischargeClean Boolean          @default(false)
  patientId       String?

  notes           String?
  photosBefore    String[]
  photosAfter     String[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  zone            HousekeepingZone  @relation(fields: [zoneId], references: [id])
  assignee        Employee?         @relation("AssignedTasks", fields: [assignedTo], references: [id])
  supervisor      Employee?         @relation("SupervisedTasks", fields: [supervisorId], references: [id])
  checklistItems  TaskChecklistItem[]

  @@map("housekeeping_tasks")
}

enum HousekeepingTaskType {
  ROUTINE_CLEANING
  DEEP_CLEANING
  DISCHARGE_CLEANING
  TERMINAL_CLEANING
  SPILL_CLEANUP
  WASTE_DISPOSAL
  LINEN_CHANGE
  BATHROOM_CLEANING
  FLOOR_MOPPING
  SANITIZATION
  WINDOW_CLEANING
  AC_VENT_CLEANING
  EMERGENCY_CLEANING
  INFECTION_CONTROL
}

enum TaskPriority {
  LOW
  NORMAL
  HIGH
  URGENT
  EMERGENCY
}

enum HousekeepingStatus {
  PENDING
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  VERIFIED
  REJECTED
  CANCELLED
}

model CleaningSchedule {
  id              String    @id @default(uuid())
  hospitalId      String
  zoneId          String
  roomNumber      String?
  taskType        HousekeepingTaskType
  frequency       CleaningFrequency
  dayOfWeek       DayOfWeek?
  dayOfMonth      Int?
  scheduledTime   String
  duration        Int       @default(30) // minutes
  assignedTeam    String?
  isActive        Boolean   @default(true)
  lastExecuted    DateTime?
  nextScheduled   DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  zone            HousekeepingZone @relation(fields: [zoneId], references: [id])

  @@map("cleaning_schedules")
}

enum CleaningFrequency {
  HOURLY
  TWICE_DAILY
  DAILY
  ALTERNATE_DAYS
  WEEKLY
  BI_WEEKLY
  MONTHLY
  QUARTERLY
  AS_NEEDED
}

model TaskChecklistItem {
  id          String    @id @default(uuid())
  taskId      String
  itemName    String
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  notes       String?
  sequence    Int       @default(0)

  task HousekeepingTask @relation(fields: [taskId], references: [id])

  @@map("task_checklist_items")
}

model CleaningChecklist {
  id          String    @id @default(uuid())
  hospitalId  String
  name        String
  taskType    HousekeepingTaskType
  items       Json      // Array of checklist items with sequence
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("cleaning_checklists")
}

model HousekeepingInventory {
  id              String    @id @default(uuid())
  hospitalId      String
  name            String
  code            String
  category        HousekeepingItemCategory
  unit            String
  currentStock    Int       @default(0)
  minStock        Int       @default(10)
  maxStock        Int?
  reorderLevel    Int       @default(20)
  lastRestocked   DateTime?
  costPerUnit     Decimal   @db.Decimal(10, 2)
  supplierId      String?
  location        String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  usageRecords    InventoryUsage[]
  supplier        Supplier? @relation(fields: [supplierId], references: [id])

  @@unique([hospitalId, code])
  @@map("housekeeping_inventory")
}

enum HousekeepingItemCategory {
  CLEANING_CHEMICAL
  DISINFECTANT
  SANITIZER
  DETERGENT
  FLOOR_CLEANER
  GLASS_CLEANER
  TOILET_CLEANER
  AIR_FRESHENER
  TRASH_BAG
  MOP
  BROOM
  BUCKET
  GLOVES
  MASK
  PPE
  LINEN
  TOWEL
  TISSUE
  SOAP
  OTHER
}

model InventoryUsage {
  id          String    @id @default(uuid())
  inventoryId String
  usedBy      String
  quantity    Int
  taskId      String?
  usedAt      DateTime  @default(now())
  notes       String?

  inventory HousekeepingInventory @relation(fields: [inventoryId], references: [id])

  @@map("inventory_usage")
}

model QualityAudit {
  id              String    @id @default(uuid())
  hospitalId      String
  zoneId          String?
  roomNumber      String?
  auditType       AuditType
  auditorId       String
  auditDate       DateTime

  // Scores (1-10)
  cleanlinessScore Int
  sanitizationScore Int
  organizationScore Int
  safetyScore     Int
  overallScore    Decimal   @db.Decimal(4, 2)

  findings        String[]
  recommendations String[]
  photosUrl       String[]

  status          AuditStatus @default(COMPLETED)
  followUpDate    DateTime?
  resolvedAt      DateTime?
  resolvedBy      String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  auditor Employee @relation(fields: [auditorId], references: [id])

  @@map("quality_audits")
}

enum AuditType {
  ROUTINE
  RANDOM
  COMPLAINT_BASED
  POST_INCIDENT
  INFECTION_CONTROL
  ACCREDITATION
}

enum AuditStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  REQUIRES_ACTION
  RESOLVED
}

// ==================== AI EXTENSIONS FOR HR & HOUSEKEEPING ====================

model AIShiftRecommendation {
  id              String    @id @default(uuid())
  hospitalId      String
  date            DateTime
  recommendations Json      // AI-generated shift assignments
  factors         Json      // Factors considered (leave, workload, skills)
  confidence      Decimal   @db.Decimal(3, 2)
  isApplied       Boolean   @default(false)
  appliedBy       String?
  appliedAt       DateTime?
  createdAt       DateTime  @default(now())

  @@map("ai_shift_recommendations")
}

model AICleaningPriority {
  id              String    @id @default(uuid())
  hospitalId      String
  date            DateTime
  priorities      Json      // AI-prioritized cleaning tasks
  factors         Json      // Infection risk, discharge schedule, etc.
  confidence      Decimal   @db.Decimal(3, 2)
  createdAt       DateTime  @default(now())

  @@map("ai_cleaning_priorities")
}

// ==================== BLOOD BANK MODULE ====================

model BloodDonor {
  id              String    @id @default(uuid())
  hospitalId      String
  donorId         String    @unique // BD-YYYYMMDD-XXX

  // Personal Info
  firstName       String
  lastName        String
  dateOfBirth     DateTime
  gender          Gender
  bloodGroup      BloodGroup
  rhFactor        RhFactor

  // Contact
  phone           String
  email           String?
  address         String
  city            String

  // Medical
  weight          Decimal   @db.Decimal(5, 2)
  hemoglobin      Decimal?  @db.Decimal(4, 1)
  lastDonationDate DateTime?
  totalDonations  Int       @default(0)

  // Eligibility
  isEligible      Boolean   @default(true)
  deferralReason  String?
  deferralUntil   DateTime?

  // Health Screening
  hasTattoo       Boolean   @default(false)
  hasRecentSurgery Boolean  @default(false)
  hasChronicDisease Boolean @default(false)
  isSmoker        Boolean   @default(false)
  isAlcoholic     Boolean   @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  donations       BloodDonation[]

  @@map("blood_donors")
}

enum RhFactor {
  POSITIVE
  NEGATIVE
}

model BloodDonation {
  id              String    @id @default(uuid())
  hospitalId      String
  donationNumber  String    @unique // DON-YYYYMMDD-XXX
  donorId         String

  donationDate    DateTime
  donationType    DonationType

  // Collection Details
  bagNumber       String    @unique
  volumeCollected Int       // ml
  collectedBy     String

  // Screening Results
  hemoglobinLevel Decimal   @db.Decimal(4, 1)
  bloodPressureSys Int
  bloodPressureDia Int
  pulseRate       Int
  temperature     Decimal   @db.Decimal(4, 1)

  // Testing Status
  testingStatus   BloodTestStatus @default(PENDING)
  hivTest         TestResult?
  hbvTest         TestResult?
  hcvTest         TestResult?
  syphilisTest    TestResult?
  malariaTest     TestResult?
  testedAt        DateTime?
  testedBy        String?

  // Processing
  isProcessed     Boolean   @default(false)
  processedAt     DateTime?
  processedBy     String?

  // Adverse Reactions
  hasReaction     Boolean   @default(false)
  reactionDetails String?

  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  donor           BloodDonor @relation(fields: [donorId], references: [id])
  components      BloodComponent[]

  @@map("blood_donations")
}

enum DonationType {
  WHOLE_BLOOD
  PLASMA
  PLATELETS
  DOUBLE_RED_CELLS
  AUTOLOGOUS
}

enum BloodTestStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum TestResult {
  NEGATIVE
  POSITIVE
  INDETERMINATE
  NOT_DONE
}

model BloodComponent {
  id              String    @id @default(uuid())
  hospitalId      String
  componentId     String    @unique // COMP-YYYYMMDD-XXX
  donationId      String

  componentType   ComponentType
  bloodGroup      BloodGroup
  rhFactor        RhFactor
  volume          Int       // ml

  // Storage
  bagNumber       String
  storageLocation String
  storageTemp     Decimal   @db.Decimal(4, 1)

  // Dates
  collectionDate  DateTime
  expiryDate      DateTime

  // Status
  status          ComponentStatus @default(AVAILABLE)

  // Quality
  qualityChecked  Boolean   @default(false)
  qualityScore    Int?      // 1-100

  // Usage
  reservedFor     String?   // Patient ID if reserved
  reservedAt      DateTime?
  issuedTo        String?
  issuedAt        DateTime?
  issuedBy        String?

  // Discard
  discardReason   String?
  discardedAt     DateTime?
  discardedBy     String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  donation        BloodDonation @relation(fields: [donationId], references: [id])
  transfusions    BloodTransfusion[]

  @@map("blood_components")
}

enum ComponentType {
  WHOLE_BLOOD
  PACKED_RED_CELLS
  FRESH_FROZEN_PLASMA
  PLATELET_CONCENTRATE
  CRYOPRECIPITATE
  LEUKOCYTE_POOR_RBC
  WASHED_RBC
  IRRADIATED_RBC
}

enum ComponentStatus {
  AVAILABLE
  RESERVED
  ISSUED
  TRANSFUSED
  EXPIRED
  DISCARDED
  QUARANTINED
}

model BloodRequest {
  id              String    @id @default(uuid())
  hospitalId      String
  requestNumber   String    @unique // REQ-YYYYMMDD-XXX

  // Patient Info
  patientId       String
  patientName     String
  patientBloodGroup BloodGroup
  patientRhFactor RhFactor

  // Request Details
  componentType   ComponentType
  unitsRequired   Int
  priority        BloodPriority
  indication      String    // Reason for transfusion

  // Requesting Doctor
  requestedBy     String
  requestedAt     DateTime  @default(now())
  department      String

  // Cross Match
  crossMatchStatus CrossMatchStatus @default(PENDING)
  crossMatchedBy  String?
  crossMatchedAt  DateTime?
  crossMatchNotes String?

  // Approval
  status          BloodRequestStatus @default(PENDING)
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?

  // Fulfillment
  unitsFulfilled  Int       @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  transfusions    BloodTransfusion[]

  @@map("blood_requests")
}

enum BloodPriority {
  ROUTINE
  URGENT
  EMERGENCY
  MASSIVE_TRANSFUSION
}

enum CrossMatchStatus {
  PENDING
  COMPATIBLE
  INCOMPATIBLE
  MINOR_INCOMPATIBLE
}

enum BloodRequestStatus {
  PENDING
  APPROVED
  PARTIALLY_FULFILLED
  FULFILLED
  REJECTED
  CANCELLED
}

model BloodTransfusion {
  id              String    @id @default(uuid())
  hospitalId      String
  transfusionNumber String  @unique // TRF-YYYYMMDD-XXX

  requestId       String
  componentId     String
  patientId       String

  // Transfusion Details
  startTime       DateTime
  endTime         DateTime?
  volumeTransfused Int?     // ml

  // Vital Signs Before
  preBPSys        Int?
  preBPDia        Int?
  prePulse        Int?
  preTemp         Decimal?  @db.Decimal(4, 1)

  // Vital Signs After
  postBPSys       Int?
  postBPDia       Int?
  postPulse       Int?
  postTemp        Decimal?  @db.Decimal(4, 1)

  // Staff
  administeredBy  String
  supervisedBy    String?

  // Reactions
  hasReaction     Boolean   @default(false)
  reactionType    TransfusionReaction?
  reactionSeverity ReactionSeverity?
  reactionDetails String?
  reactionTime    DateTime?
  actionTaken     String?

  status          TransfusionStatus @default(IN_PROGRESS)
  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  request         BloodRequest @relation(fields: [requestId], references: [id])
  component       BloodComponent @relation(fields: [componentId], references: [id])

  @@map("blood_transfusions")
}

enum TransfusionReaction {
  FEBRILE
  ALLERGIC
  HEMOLYTIC_ACUTE
  HEMOLYTIC_DELAYED
  TRANSFUSION_RELATED_LUNG_INJURY
  CIRCULATORY_OVERLOAD
  BACTERIAL_CONTAMINATION
  ANAPHYLACTIC
  OTHER
}

enum ReactionSeverity {
  MILD
  MODERATE
  SEVERE
  LIFE_THREATENING
}

enum TransfusionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  STOPPED
  REACTION_OCCURRED
}

// ==================== MEDICAL RECORDS / EMR ====================

model MedicalDocument {
  id              String    @id @default(uuid())
  hospitalId      String
  documentNumber  String    @unique // DOC-YYYYMMDD-XXX
  patientId       String

  documentType    DocumentCategory
  title           String
  description     String?

  // File Info
  fileUrl         String
  fileName        String
  fileSize        Int       // bytes
  mimeType        String

  // Metadata
  documentDate    DateTime
  uploadedBy      String
  uploadedAt      DateTime  @default(now())

  // Source
  sourceType      DocumentSource
  encounterId     String?   // Admission, Appointment, etc.
  departmentId    String?

  // Verification
  isVerified      Boolean   @default(false)
  verifiedBy      String?
  verifiedAt      DateTime?

  // Access Control
  isConfidential  Boolean   @default(false)
  accessLevel     AccessLevel @default(NORMAL)

  // AI Extracted Data
  aiExtractedText String?
  aiSummary       String?
  aiTags          String[]

  tags            String[]
  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("medical_documents")
}

enum DocumentCategory {
  CONSENT_FORM
  DISCHARGE_SUMMARY
  OPERATIVE_REPORT
  LAB_REPORT
  IMAGING_REPORT
  PRESCRIPTION
  REFERRAL_LETTER
  MEDICAL_CERTIFICATE
  INSURANCE_FORM
  DEATH_CERTIFICATE
  BIRTH_CERTIFICATE
  VACCINATION_RECORD
  ALLERGY_CARD
  BLOOD_REPORT
  PATHOLOGY_REPORT
  ECG_REPORT
  XRAY_IMAGE
  CT_SCAN
  MRI_SCAN
  ULTRASOUND
  OTHER
}

enum DocumentSource {
  UPLOAD
  SCAN
  SYSTEM_GENERATED
  EXTERNAL
  FAX
  EMAIL
}

enum AccessLevel {
  PUBLIC
  NORMAL
  RESTRICTED
  CONFIDENTIAL
  HIGHLY_CONFIDENTIAL
}

model ConsentForm {
  id              String    @id @default(uuid())
  hospitalId      String
  consentNumber   String    @unique
  patientId       String

  consentType     ConsentType
  procedureName   String?

  // Content
  consentText     String
  language        String    @default("en")

  // Signatures
  patientSignature String?
  patientSignedAt DateTime?
  witnessName     String?
  witnessSignature String?
  witnessSignedAt DateTime?
  doctorId        String?
  doctorSignature String?
  doctorSignedAt  DateTime?

  // Status
  status          ConsentStatus @default(PENDING)
  expiryDate      DateTime?
  revokedAt       DateTime?
  revokedReason   String?

  documentUrl     String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("consent_forms")
}

enum ConsentType {
  GENERAL_TREATMENT
  SURGICAL_PROCEDURE
  ANESTHESIA
  BLOOD_TRANSFUSION
  HIV_TESTING
  RESEARCH_PARTICIPATION
  PHOTOGRAPHY
  DATA_SHARING
  LEAVE_AGAINST_ADVICE
  DNR
  ORGAN_DONATION
}

enum ConsentStatus {
  PENDING
  SIGNED
  EXPIRED
  REVOKED
}

// ==================== CSSD (Central Sterile Services) ====================

model SterilizationItem {
  id              String    @id @default(uuid())
  hospitalId      String
  itemCode        String    @unique

  name            String
  category        InstrumentCategory
  description     String?

  // Specifications
  manufacturer    String?
  model           String?
  serialNumber    String?

  // Sterilization Requirements
  sterilizationMethod SterilizationMethod
  sterilizationTemp Int?    // Celsius
  sterilizationTime Int?    // Minutes

  // Tracking
  currentLocation String
  currentStatus   ItemSterilizationStatus @default(AVAILABLE)
  lastSterilizedAt DateTime?
  lastUsedAt      DateTime?

  // Maintenance
  totalUseCount   Int       @default(0)
  maxUseCount     Int?
  nextMaintenanceDate DateTime?

  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  cycleItems      SterilizationCycleItem[]

  @@map("sterilization_items")
}

enum InstrumentCategory {
  SURGICAL_INSTRUMENT
  SURGICAL_SET
  ENDOSCOPE
  LAPAROSCOPIC
  ORTHOPEDIC
  DENTAL
  OPHTHALMIC
  ENT
  CARDIAC
  NEURO
  LINEN
  CONTAINER
  OTHER
}

enum SterilizationMethod {
  STEAM_AUTOCLAVE
  ETO_GAS
  PLASMA
  DRY_HEAT
  CHEMICAL
  RADIATION
}

enum ItemSterilizationStatus {
  AVAILABLE
  IN_USE
  DIRTY
  IN_WASHING
  IN_STERILIZATION
  STERILE
  EXPIRED
  MAINTENANCE
  CONDEMNED
}

model SterilizationCycle {
  id              String    @id @default(uuid())
  hospitalId      String
  cycleNumber     String    @unique // CYC-YYYYMMDD-XXX

  machineId       String
  machineName     String
  method          SterilizationMethod

  // Cycle Parameters
  temperature     Decimal   @db.Decimal(5, 1)
  pressure        Decimal?  @db.Decimal(5, 2)
  duration        Int       // Minutes

  // Timing
  startTime       DateTime
  endTime         DateTime?

  // Load Details
  loadDescription String?
  itemCount       Int

  // Quality Indicators
  chemicalIndicator ChemicalIndicatorResult?
  biologicalIndicator BiologicalIndicatorResult?

  // Operator
  operatorId      String
  verifiedBy      String?
  verifiedAt      DateTime?

  status          CycleStatus @default(IN_PROGRESS)
  failureReason   String?

  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  items           SterilizationCycleItem[]

  @@map("sterilization_cycles")
}

enum ChemicalIndicatorResult {
  PASS
  FAIL
  NOT_DONE
}

enum BiologicalIndicatorResult {
  PASS
  FAIL
  PENDING
  NOT_DONE
}

enum CycleStatus {
  LOADING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

model SterilizationCycleItem {
  id              String    @id @default(uuid())
  cycleId         String
  itemId          String

  quantity        Int       @default(1)

  // Post-cycle status
  postCycleStatus ItemSterilizationStatus @default(STERILE)
  expiryDate      DateTime

  createdAt       DateTime  @default(now())

  cycle           SterilizationCycle @relation(fields: [cycleId], references: [id])
  item            SterilizationItem @relation(fields: [itemId], references: [id])

  @@map("sterilization_cycle_items")
}

// ==================== MORTUARY / DEATH MANAGEMENT ====================

model MortuaryRecord {
  id              String    @id @default(uuid())
  hospitalId      String
  recordNumber    String    @unique // MORT-YYYYMMDD-XXX

  // Deceased Info
  patientId       String?
  deceasedName    String
  dateOfBirth     DateTime?
  dateOfDeath     DateTime
  timeOfDeath     DateTime
  age             Int?
  gender          Gender

  // Death Details
  placeOfDeath    String
  causeOfDeath    String
  mannerOfDeath   MannerOfDeath

  // Medical Certification
  certifyingDoctor String
  certifiedAt     DateTime?
  deathCertificateNumber String?
  deathCertificateUrl String?

  // Autopsy
  autopsyRequired Boolean   @default(false)
  autopsyStatus   AutopsyStatus?
  autopsyFindings String?
  autopsyDoctor   String?
  autopsyDate     DateTime?

  // Body Storage
  compartmentNumber String?
  storageLocation String?
  bodyReceivedAt  DateTime?
  receivedBy      String?
  bodyCondition   String?

  // Identification
  identificationMarks String?
  belongings      String[]
  belongingsReceivedBy String?

  // Next of Kin
  nokName         String
  nokRelationship String
  nokPhone        String
  nokAddress      String?
  nokIdProof      String?

  // Release
  releaseStatus   ReleaseStatus @default(NOT_RELEASED)
  releasedTo      String?
  releasedAt      DateTime?
  releaseAuthorizedBy String?
  policeNocNumber String?
  undertakerName  String?
  undertakerLicense String?

  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("mortuary_records")
}

enum MannerOfDeath {
  NATURAL
  ACCIDENT
  SUICIDE
  HOMICIDE
  UNDETERMINED
  PENDING_INVESTIGATION
}

enum AutopsyStatus {
  NOT_REQUIRED
  PENDING
  IN_PROGRESS
  COMPLETED
  WAIVED
}

enum ReleaseStatus {
  NOT_RELEASED
  PENDING_DOCUMENTS
  PENDING_NOC
  APPROVED
  RELEASED
}

// ==================== KITCHEN / DIETARY SERVICES ====================

model DietPlan {
  id              String    @id @default(uuid())
  hospitalId      String
  planCode        String    @unique

  name            String
  description     String?
  category        DietCategory

  // Nutritional Info per day
  calories        Int?
  protein         Decimal?  @db.Decimal(6, 2)
  carbohydrates   Decimal?  @db.Decimal(6, 2)
  fat             Decimal?  @db.Decimal(6, 2)
  fiber           Decimal?  @db.Decimal(6, 2)
  sodium          Decimal?  @db.Decimal(6, 2)

  // Restrictions
  restrictions    String[]
  allergens       String[]

  // Meals
  breakfastItems  String[]
  lunchItems      String[]
  dinnerItems     String[]
  snackItems      String[]

  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  patientDiets    PatientDiet[]

  @@map("diet_plans")
}

enum DietCategory {
  REGULAR
  SOFT
  LIQUID
  CLEAR_LIQUID
  NPO
  DIABETIC
  LOW_SODIUM
  LOW_FAT
  HIGH_PROTEIN
  RENAL
  CARDIAC
  PEDIATRIC
  GERIATRIC
  VEGETARIAN
  VEGAN
  HALAL
  KOSHER
  GLUTEN_FREE
  LACTOSE_FREE
}

model PatientDiet {
  id              String    @id @default(uuid())
  hospitalId      String
  patientId       String
  admissionId     String?

  dietPlanId      String

  // Customizations
  specialInstructions String?
  allergies       String[]
  preferences     String[]
  avoidItems      String[]

  // Feeding
  feedingMethod   FeedingMethod @default(ORAL)
  assistanceRequired Boolean @default(false)

  // Schedule
  startDate       DateTime
  endDate         DateTime?

  // Prescription
  prescribedBy    String
  prescribedAt    DateTime

  status          DietStatus @default(ACTIVE)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  dietPlan        DietPlan @relation(fields: [dietPlanId], references: [id])
  mealOrders      MealOrder[]

  @@map("patient_diets")
}

enum FeedingMethod {
  ORAL
  NASOGASTRIC
  PEG_TUBE
  PARENTERAL
  ASSISTED
}

enum DietStatus {
  ACTIVE
  SUSPENDED
  COMPLETED
  CANCELLED
}

model MealOrder {
  id              String    @id @default(uuid())
  hospitalId      String
  orderNumber     String    @unique

  patientDietId   String
  patientId       String
  bedNumber       String
  wardName        String

  mealType        MealType
  mealDate        DateTime

  // Items
  items           Json      // Array of meal items
  specialRequest  String?

  // Timing
  scheduledTime   DateTime
  preparedAt      DateTime?
  deliveredAt     DateTime?

  // Staff
  preparedBy      String?
  deliveredBy     String?

  // Status
  status          MealOrderStatus @default(PENDING)

  // Consumption
  consumptionPercent Int?    // 0-100
  consumptionNotes String?
  recordedBy      String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  patientDiet     PatientDiet @relation(fields: [patientDietId], references: [id])

  @@map("meal_orders")
}

enum MealType {
  BREAKFAST
  MORNING_SNACK
  LUNCH
  AFTERNOON_SNACK
  DINNER
  EVENING_SNACK
  SNACK
  SPECIAL
  OTHER
}

enum MealOrderStatus {
  PENDING
  PREPARING
  READY
  DELIVERED
  CONSUMED
  RETURNED
  CANCELLED
}

// ==================== TELEMEDICINE ====================

model TeleconsultationSession {
  id              String    @id @default(uuid())
  hospitalId      String
  sessionId       String    @unique // TELE-YYYYMMDD-XXX

  appointmentId   String?
  patientId       String
  doctorId        String

  // Schedule
  scheduledStart  DateTime
  scheduledEnd    DateTime
  actualStart     DateTime?
  actualEnd       DateTime?

  // Session Details
  sessionType     TeleSessionType
  platform        String    @default("internal")
  meetingUrl      String?
  meetingId       String?

  // Technical
  patientDeviceInfo Json?
  doctorDeviceInfo Json?
  connectionQuality ConnectionQuality?

  // Clinical
  chiefComplaint  String?
  symptoms        String[]
  diagnosis       String?
  prescription    String?
  followUpDate    DateTime?

  // Notes
  doctorNotes     String?
  patientFeedback String?
  rating          Int?      // 1-5

  // Recording
  isRecorded      Boolean   @default(false)
  recordingUrl    String?

  // AI Features
  aiSymptomAnalysis Json?
  aiTriageSuggestion String?
  aiTranscript    String?

  status          TeleSessionStatus @default(SCHEDULED)
  cancellationReason String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("teleconsultation_sessions")
}

enum TeleSessionType {
  VIDEO_CALL
  AUDIO_CALL
  CHAT
  FOLLOW_UP
  SECOND_OPINION
  EMERGENCY
}

enum ConnectionQuality {
  EXCELLENT
  GOOD
  FAIR
  POOR
}

enum TeleSessionStatus {
  SCHEDULED
  WAITING
  IN_PROGRESS
  COMPLETED
  NO_SHOW
  CANCELLED
  TECHNICAL_ISSUE
}

// ==================== ASSET MANAGEMENT ====================

model Asset {
  id              String    @id @default(uuid())
  hospitalId      String
  assetCode       String    @unique // AST-YYYYMMDD-XXX

  name            String
  category        AssetCategory
  subCategory     String?
  description     String?

  // Identification
  manufacturer    String?
  model           String?
  serialNumber    String?
  barcode         String?

  // Acquisition
  purchaseDate    DateTime?
  purchasePrice   Decimal?  @db.Decimal(12, 2)
  vendor          String?
  warrantyExpiry  DateTime?

  // Location
  department      String?
  building        String?
  floor           String?
  room            String?

  // Status
  status          AssetStatus @default(ACTIVE)
  condition       AssetCondition @default(GOOD)

  // Depreciation
  usefulLife      Int?      // Years
  depreciationRate Decimal? @db.Decimal(5, 2)
  currentValue    Decimal?  @db.Decimal(12, 2)

  // AMC (Annual Maintenance Contract)
  hasAMC          Boolean   @default(false)
  amcVendor       String?
  amcStartDate    DateTime?
  amcEndDate      DateTime?
  amcCost         Decimal?  @db.Decimal(10, 2)

  // Calibration (for medical equipment)
  requiresCalibration Boolean @default(false)
  lastCalibrationDate DateTime?
  nextCalibrationDate DateTime?

  // Usage
  lastUsedAt      DateTime?
  totalUsageHours Int?

  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  maintenanceRecords AssetMaintenance[]

  @@map("assets")
}

enum AssetCategory {
  MEDICAL_EQUIPMENT
  DIAGNOSTIC_EQUIPMENT
  SURGICAL_EQUIPMENT
  MONITORING_EQUIPMENT
  LIFE_SUPPORT
  LABORATORY_EQUIPMENT
  IMAGING_EQUIPMENT
  FURNITURE
  IT_EQUIPMENT
  VEHICLE
  BUILDING
  OTHER
}

enum AssetStatus {
  ACTIVE
  INACTIVE
  UNDER_MAINTENANCE
  DISPOSED
  TRANSFERRED
  LOST
}

enum AssetCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  CONDEMNED
}

model AssetMaintenance {
  id              String    @id @default(uuid())
  hospitalId      String
  maintenanceNumber String  @unique
  assetId         String

  maintenanceType MaintenanceType
  priority        TaskPriority @default(NORMAL)

  // Schedule
  scheduledDate   DateTime?
  startDate       DateTime?
  completionDate  DateTime?

  // Details
  description     String
  findings        String?
  actionTaken     String?
  partsReplaced   String[]

  // Cost
  laborCost       Decimal?  @db.Decimal(10, 2)
  partsCost       Decimal?  @db.Decimal(10, 2)
  totalCost       Decimal?  @db.Decimal(10, 2)

  // Vendor
  performedBy     String?
  vendorName      String?
  vendorContact   String?

  // Next Maintenance
  nextMaintenanceDate DateTime?

  status          MaintenanceStatus @default(SCHEDULED)

  // AI Predictions
  aiPredictedFailure DateTime?
  aiRecommendations String[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  asset           Asset @relation(fields: [assetId], references: [id])

  @@map("asset_maintenance")
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
  CALIBRATION
  INSPECTION
  EMERGENCY
  AMC_SERVICE
}

enum MaintenanceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OVERDUE
}

// ==================== AMBULANCE / TRANSPORT ====================

model Ambulance {
  id              String    @id @default(uuid())
  hospitalId      String
  vehicleNumber   String    @unique

  // Vehicle Info
  vehicleType     AmbulanceType
  make            String?
  model           String?
  year            Int?

  // Equipment
  equipmentList   String[]
  hasVentilator   Boolean   @default(false)
  hasDefibrillator Boolean  @default(false)
  hasOxygenSupply Boolean   @default(true)

  // Status
  status          AmbulanceStatus @default(AVAILABLE)
  currentLocation String?
  lastLatitude    Decimal?  @db.Decimal(10, 8)
  lastLongitude   Decimal?  @db.Decimal(11, 8)
  lastLocationUpdate DateTime?

  // Crew
  driverId        String?
  paramedicId     String?

  // Maintenance
  lastServiceDate DateTime?
  nextServiceDate DateTime?
  mileage         Int?
  fuelLevel       Int?      // Percentage

  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  trips           AmbulanceTrip[]

  @@map("ambulances")
}

enum AmbulanceType {
  BASIC_LIFE_SUPPORT
  ADVANCED_LIFE_SUPPORT
  PATIENT_TRANSPORT
  NEONATAL
  BARIATRIC
  AIR_AMBULANCE
}

enum AmbulanceStatus {
  AVAILABLE
  ON_CALL
  EN_ROUTE_TO_SCENE
  AT_SCENE
  EN_ROUTE_TO_HOSPITAL
  AT_HOSPITAL
  OUT_OF_SERVICE
  MAINTENANCE
}

model AmbulanceTrip {
  id              String    @id @default(uuid())
  hospitalId      String
  tripNumber      String    @unique // TRIP-YYYYMMDD-XXX

  ambulanceId     String

  // Request
  requestType     TripRequestType
  priority        TripPriority
  requestedAt     DateTime
  requestedBy     String

  // Patient (if known)
  patientName     String?
  patientAge      Int?
  patientGender   Gender?
  patientCondition String?

  // Pickup
  pickupAddress   String
  pickupLatitude  Decimal?  @db.Decimal(10, 8)
  pickupLongitude Decimal?  @db.Decimal(11, 8)
  pickupContact   String?

  // Destination
  destinationAddress String
  destinationLatitude Decimal? @db.Decimal(10, 8)
  destinationLongitude Decimal? @db.Decimal(11, 8)

  // Timing
  dispatchedAt    DateTime?
  arrivedAtScene  DateTime?
  departedScene   DateTime?
  arrivedAtDestination DateTime?
  completedAt     DateTime?

  // Distance & Duration
  distanceKm      Decimal?  @db.Decimal(8, 2)
  durationMinutes Int?

  // Crew
  driverId        String?
  paramedicIds    String[]

  // Medical Care
  treatmentProvided String?
  medicationsGiven String[]
  vitalsRecorded  Json?

  // AI Routing
  aiOptimalRoute  Json?
  aiEstimatedTime Int?

  status          TripStatus @default(REQUESTED)
  cancellationReason String?

  // Billing
  chargeAmount    Decimal?  @db.Decimal(10, 2)
  isPaid          Boolean   @default(false)

  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  ambulance       Ambulance @relation(fields: [ambulanceId], references: [id])

  @@map("ambulance_trips")
}

enum TripRequestType {
  EMERGENCY_PICKUP
  INTER_HOSPITAL_TRANSFER
  SCHEDULED_TRANSPORT
  DISCHARGE_TRANSPORT
  DIALYSIS_TRANSPORT
  OUTPATIENT_TRANSPORT
}

enum TripPriority {
  EMERGENCY
  URGENT
  ROUTINE
  SCHEDULED
}

enum TripStatus {
  REQUESTED
  DISPATCHED
  EN_ROUTE_TO_PICKUP
  AT_PICKUP
  EN_ROUTE_TO_DESTINATION
  AT_DESTINATION
  COMPLETED
  CANCELLED
  NO_PATIENT
}

// ==================== QUALITY MANAGEMENT (NABH/JCI) ====================

model QualityIndicator {
  id              String    @id @default(uuid())
  hospitalId      String

  code            String
  name            String
  category        QICategory

  // Definition
  description     String
  numeratorDef    String
  denominatorDef  String
  formula         String

  // Target
  targetValue     Decimal   @db.Decimal(8, 4)
  thresholdGreen  Decimal   @db.Decimal(8, 4)
  thresholdYellow Decimal   @db.Decimal(8, 4)
  thresholdRed    Decimal   @db.Decimal(8, 4)

  // Frequency
  frequency       QIFrequency

  // Benchmark
  nationalBenchmark Decimal? @db.Decimal(8, 4)
  internalBenchmark Decimal? @db.Decimal(8, 4)

  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  measurements    QIMeasurement[]

  @@unique([hospitalId, code])
  @@map("quality_indicators")
}

enum QICategory {
  PATIENT_SAFETY
  CLINICAL_OUTCOMES
  INFECTION_CONTROL
  MEDICATION_SAFETY
  SURGICAL_SAFETY
  EMERGENCY_CARE
  ICU_CARE
  NURSING_CARE
  DIAGNOSTIC_SERVICES
  PATIENT_EXPERIENCE
  ACCESS_TIMELINESS
  OPERATIONAL_EFFICIENCY
}

enum QIFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

model QIMeasurement {
  id              String    @id @default(uuid())
  hospitalId      String
  indicatorId     String

  periodStart     DateTime
  periodEnd       DateTime

  numerator       Int
  denominator     Int
  value           Decimal   @db.Decimal(8, 4)

  status          QIStatus

  // Analysis
  trend           QITrend?
  rootCause       String?
  actionPlan      String?

  // AI Analysis
  aiAnalysis      String?
  aiRecommendations String[]

  recordedBy      String
  verifiedBy      String?
  verifiedAt      DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  indicator       QualityIndicator @relation(fields: [indicatorId], references: [id])

  @@map("qi_measurements")
}

enum QIStatus {
  ACHIEVED
  NOT_ACHIEVED
  BELOW_THRESHOLD
  NEEDS_IMPROVEMENT
}

enum QITrend {
  IMPROVING
  STABLE
  DECLINING
}

model IncidentReport {
  id              String    @id @default(uuid())
  hospitalId      String
  reportNumber    String    @unique // INC-YYYYMMDD-XXX

  // Incident Details
  incidentType    IncidentType
  severity        IncidentSeverity

  incidentDate    DateTime
  incidentTime    DateTime
  location        String
  department      String?

  description     String

  // People Involved
  patientId       String?
  patientName     String?
  staffInvolved   String[]
  witnessNames    String[]

  // Immediate Actions
  immediateAction String?
  patientHarm     PatientHarmLevel?

  // Investigation
  investigatorId  String?
  investigationStarted DateTime?
  investigationFindings String?
  rootCause       String?
  contributingFactors String[]

  // Corrective Actions
  correctiveActions Json?
  preventiveActions Json?

  // Status
  status          IncidentStatus @default(REPORTED)
  closedAt        DateTime?
  closedBy        String?

  // Reporting
  reportedBy      String
  reportedAt      DateTime  @default(now())
  isAnonymous     Boolean   @default(false)

  // AI Analysis
  aiClassification String?
  aiSeverityScore Int?
  aiSimilarIncidents String[]
  aiRecommendations String[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("incident_reports")
}

enum IncidentType {
  MEDICATION_ERROR
  FALL
  PRESSURE_ULCER
  SURGICAL_COMPLICATION
  HOSPITAL_ACQUIRED_INFECTION
  NEEDLE_STICK
  BLOOD_TRANSFUSION_REACTION
  DIAGNOSTIC_ERROR
  EQUIPMENT_FAILURE
  SECURITY_BREACH
  PATIENT_COMPLAINT
  ADVERSE_DRUG_REACTION
  NEAR_MISS
  OTHER
}

enum IncidentSeverity {
  NEAR_MISS
  MINOR
  MODERATE
  MAJOR
  CATASTROPHIC
}

enum PatientHarmLevel {
  NO_HARM
  MILD
  MODERATE
  SEVERE
  DEATH
}

enum IncidentStatus {
  REPORTED
  UNDER_INVESTIGATION
  ACTION_REQUIRED
  ACTIONS_IN_PROGRESS
  CLOSED
}

// ==================== SMART QUEUE MANAGEMENT ====================

model QueueCounter {
  id              String         @id @default(uuid())
  hospitalId      String
  departmentId    String?
  counterNumber   Int
  counterName     String
  counterType     CounterType
  location        String?
  floor           String?
  isActive        Boolean        @default(true)
  currentTicketId String?
  currentStaffId  String?
  avgServiceTime  Int            @default(10) // minutes
  servicesOffered String[]       // service codes this counter handles
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  tickets         QueueTicket[]

  @@unique([hospitalId, counterNumber])
  @@map("queue_counters")
}

enum CounterType {
  REGISTRATION
  CONSULTATION
  BILLING
  PHARMACY
  LABORATORY
  RADIOLOGY
  VACCINATION
  BLOOD_COLLECTION
  REPORT_COLLECTION
  GENERAL
}

model QueueTicket {
  id              String          @id @default(uuid())
  hospitalId      String
  ticketNumber    String          // e.g., "A001", "B045"
  tokenDisplay    String          // Display format "A-001"
  patientId       String?
  patientName     String
  patientPhone    String?
  appointmentId   String?

  // Queue Details
  departmentId    String?
  serviceType     String          // registration, consultation, billing, etc.
  counterId       String?
  priority        QueuePriority   @default(NORMAL)
  status          QueueStatus     @default(WAITING)

  // Timing
  issuedAt        DateTime        @default(now())
  calledAt        DateTime?
  servedAt        DateTime?       // when service started
  completedAt     DateTime?
  cancelledAt     DateTime?
  noShowAt        DateTime?

  // Wait Time Tracking
  estimatedWaitTime Int?          // minutes (AI predicted)
  actualWaitTime  Int?            // minutes (calculated)
  serviceTime     Int?            // minutes

  // Position Tracking
  queuePosition   Int             @default(0)
  initialPosition Int             @default(0)

  // AI Features
  aiPriorityScore Float?          // AI-calculated priority
  aiRecommendedCounter String?
  urgencyLevel    String?         // from symptom analysis

  // Notifications
  smsNotified     Boolean         @default(false)
  callCount       Int             @default(0)
  lastCalledAt    DateTime?

  // Additional Info
  notes           String?
  cancellationReason String?
  servedBy        String?         // staff ID who served

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  counter         QueueCounter?   @relation(fields: [counterId], references: [id])

  @@unique([hospitalId, ticketNumber, issuedAt])
  @@index([hospitalId, status, issuedAt])
  @@index([hospitalId, departmentId, status])
  @@index([hospitalId, serviceType, status])
  @@map("queue_tickets")
}

enum QueuePriority {
  EMERGENCY
  HIGH
  NORMAL
  LOW
  VIP
  SENIOR_CITIZEN
  PREGNANT
  DISABLED
  CHILD
}

enum QueueStatus {
  WAITING
  CALLED
  SERVING
  ON_HOLD
  COMPLETED
  NO_SHOW
  CANCELLED
  TRANSFERRED
  SKIPPED
}

model QueueConfig {
  id                  String    @id @default(uuid())
  hospitalId          String
  departmentId        String?
  serviceType         String    @unique

  // Queue Settings
  prefix              String    // A, B, C for different queues
  dailyReset          Boolean   @default(true)
  maxDailyTickets     Int       @default(999)
  operatingHoursStart String    @default("08:00")
  operatingHoursEnd   String    @default("20:00")

  // Priority Settings
  priorityEnabled     Boolean   @default(true)
  emergencyMultiplier Float     @default(3.0)
  vipMultiplier       Float     @default(2.0)
  seniorMultiplier    Float     @default(1.5)

  // Wait Time Settings
  avgServiceTime      Int       @default(10) // minutes
  maxWaitTime         Int       @default(60) // minutes, trigger alert

  // Notification Settings
  smsAlertEnabled     Boolean   @default(true)
  alertBeforePosition Int       @default(3) // notify when X positions away
  noShowTimeout       Int       @default(5) // minutes to mark no-show
  recallLimit         Int       @default(3) // max times to call

  // Display Settings
  displayMessage      String?
  announcementEnabled Boolean   @default(true)

  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("queue_configs")
}

model QueueDisplayBoard {
  id              String    @id @default(uuid())
  hospitalId      String
  boardName       String
  location        String
  boardType       DisplayBoardType @default(DEPARTMENT)
  departmentIds   String[]  // departments to show
  counterIds      String[]  // specific counters to show
  displayMode     String    @default("list") // list, grid, ticker
  ticketsToShow   Int       @default(10)
  refreshInterval Int       @default(5) // seconds
  showEstimatedTime Boolean @default(true)
  showCounter     Boolean   @default(true)
  customMessage   String?
  theme           String    @default("default")
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("queue_display_boards")
}

enum DisplayBoardType {
  MAIN_LOBBY
  DEPARTMENT
  COUNTER
  PHARMACY
  LAB
  BILLING
}

model QueueAnalytics {
  id              String    @id @default(uuid())
  hospitalId      String
  departmentId    String?
  serviceType     String?
  date            DateTime  @db.Date
  hour            Int?      // 0-23, null for daily aggregate

  // Counts
  totalTickets    Int       @default(0)
  servedTickets   Int       @default(0)
  noShowTickets   Int       @default(0)
  cancelledTickets Int      @default(0)

  // Wait Times (minutes)
  avgWaitTime     Float     @default(0)
  minWaitTime     Int       @default(0)
  maxWaitTime     Int       @default(0)

  // Service Times (minutes)
  avgServiceTime  Float     @default(0)
  minServiceTime  Int       @default(0)
  maxServiceTime  Int       @default(0)

  // Peak Analysis
  peakHour        Int?
  peakWaitTime    Int?

  // Staff Performance
  staffPerformance Json?    // { staffId: { served, avgTime } }

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([hospitalId, departmentId, serviceType, date, hour])
  @@index([hospitalId, date])
  @@map("queue_analytics")
}

model QueueAnnouncement {
  id              String    @id @default(uuid())
  hospitalId      String
  ticketId        String
  ticketNumber    String
  counterNumber   Int
  counterName     String
  patientName     String?
  announcementText String
  audioUrl        String?
  playedAt        DateTime?
  status          String    @default("pending") // pending, played, failed
  createdAt       DateTime  @default(now())

  @@index([hospitalId, status])
  @@map("queue_announcements")
}

// ==================== SMART ORDERS ====================

model SmartOrder {
  id            String   @id @default(uuid())
  hospitalId    String
  hospital      Hospital @relation(fields: [hospitalId], references: [id])
  patientId     String
  patient       Patient  @relation(fields: [patientId], references: [id])
  orderedById   String
  orderedBy     User     @relation("OrderedByUser", fields: [orderedById], references: [id])

  // Order metadata
  orderNumber   String   @unique @default(uuid())
  diagnosis     String
  icdCode       String?
  symptoms      String[]

  // AI metadata
  aiRecommended Boolean  @default(false)
  bundleId      String?
  bundleName    String?

  // Status tracking
  status        SmartOrderStatus @default(PENDING)
  priority      String   @default("ROUTINE")

  // Cost and notes
  totalEstimatedCost Float?
  notes         String?

  // Timestamps
  orderedAt     DateTime @default(now())
  completedAt   DateTime?
  cancelledAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  items         SmartOrderItem[]

  @@index([hospitalId, patientId])
  @@index([hospitalId, status])
  @@index([orderedById])
  @@index([orderNumber])
}

model SmartOrderItem {
  id            String   @id @default(uuid())
  smartOrderId  String
  smartOrder    SmartOrder @relation(fields: [smartOrderId], references: [id], onDelete: Cascade)

  // Order item details
  orderType     SmartOrderItemType
  orderCode     String?
  orderName     String
  category      String
  urgency       String   @default("ROUTINE")
  quantity      Int      @default(1)

  // AI recommendation data
  aiRecommended Boolean  @default(false)
  confidence    Float?
  rationale     String?

  // Dosing info (for medications)
  dosing        Json?

  // Warnings and alternatives
  warnings      String[]
  alternatives  Json?

  // Status
  status        SmartOrderItemStatus @default(PENDING)
  estimatedCost Float?

  // Execution tracking
  executedAt    DateTime?
  executedById  String?
  executedBy    User?    @relation("ExecutedByUser", fields: [executedById], references: [id])
  resultNotes   String?

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([smartOrderId])
  @@index([orderType])
  @@index([status])
}

enum SmartOrderStatus {
  PENDING
  PARTIALLY_COMPLETED
  COMPLETED
  CANCELLED
}

enum SmartOrderItemType {
  LAB
  IMAGING
  MEDICATION
  PROCEDURE
  NURSING
  CONSULT
  REFERRAL
}

enum SmartOrderItemStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============= AI Scribe Clinical Notes =============

model ClinicalNote {
  id            String   @id @default(uuid())
  hospitalId    String
  hospital      Hospital @relation(fields: [hospitalId], references: [id])
  patientId     String
  patient       Patient  @relation(fields: [patientId], references: [id])
  authorId      String
  author        User     @relation("ClinicalNoteAuthor", fields: [authorId], references: [id])

  // Optional links
  consultationId String?
  consultation   Consultation? @relation(fields: [consultationId], references: [id])
  appointmentId  String?
  appointment    Appointment?  @relation("ClinicalNoteAppointment", fields: [appointmentId], references: [id])

  // Note content
  noteType      ClinicalNoteType
  subjective    String?  @db.Text
  objective     String?  @db.Text
  assessment    String?  @db.Text
  plan          String?  @db.Text
  fullText      String?  @db.Text

  // Status and workflow
  status        ClinicalNoteStatus @default(DRAFT)

  // AI metadata
  aiGenerated   Boolean  @default(false)
  aiSessionId   String?
  aiSession     AiScribeSession? @relation(fields: [aiSessionId], references: [id])
  transcriptId  String?
  modelVersion  String?

  // Code suggestions
  suggestedIcdCodes Json?
  suggestedCptCodes Json?
  keyFindings       String[]

  // Signing
  signedAt      DateTime?
  signedById    String?
  signedBy      User?    @relation("ClinicalNoteSigner", fields: [signedById], references: [id])

  // Relations
  diagnoses     NoteDiagnosis[]
  prescriptions NoteExtractedPrescription[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([hospitalId, patientId])
  @@index([hospitalId, authorId])
  @@index([hospitalId, status])
  @@index([aiSessionId])
}

model NoteDiagnosis {
  id          String       @id @default(uuid())
  noteId      String
  note        ClinicalNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  diagnosis   String
  isPrimary   Boolean      @default(false)
  icdCode     String?
  confidence  Float?

  createdAt   DateTime @default(now())

  @@index([noteId])
}

model NoteExtractedPrescription {
  id           String       @id @default(uuid())
  noteId       String
  note         ClinicalNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  medication   String
  dosage       String?
  frequency    String?
  duration     String?
  route        String?
  instructions String?
  warnings     String[]
  reason       String?

  createdAt    DateTime @default(now())

  @@index([noteId])
}

model AiScribeSession {
  id            String   @id @default(uuid())
  hospitalId    String
  hospital      Hospital @relation(fields: [hospitalId], references: [id])
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  patientId     String?
  patient       Patient? @relation(fields: [patientId], references: [id])
  appointmentId String?

  // Session metadata
  sessionType   String   @default("consultation")
  status        ScribeSessionStatus @default(ACTIVE)

  // Patient context (stored for reference)
  patientContext Json?

  // Transcript data
  transcriptText  String? @db.Text
  transcriptSegments Json?

  // Generated content
  extractedEntities Json?
  generatedNote     Json?

  // Result
  noteId        String?
  notes         ClinicalNote[]

  // Timestamps
  startedAt     DateTime @default(now())
  completedAt   DateTime?

  @@index([hospitalId, status])
  @@index([hospitalId, userId])
  @@index([patientId])
}

enum ClinicalNoteType {
  SOAP
  PROGRESS
  PROCEDURE
  DISCHARGE
  ADMISSION
  CONSULTATION
  FOLLOW_UP
  EMERGENCY
  TELEHEALTH
}

enum ClinicalNoteStatus {
  DRAFT
  PENDING_REVIEW
  SIGNED
  AMENDED
  ADDENDUM
}

enum ScribeSessionStatus {
  ACTIVE
  TRANSCRIBING
  GENERATING_NOTE
  NOTE_GENERATED
  COMPLETED
  CANCELLED
  ERROR
}

// =============================================================================
// HEALTH SYNC & WELLNESS MODELS
// =============================================================================

model HealthDeviceConnection {
  id            String   @id @default(uuid())
  patientId     String
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  provider      HealthProvider
  providerUserId String?
  accessToken   String?  @db.Text
  refreshToken  String?  @db.Text
  tokenExpiry   DateTime?
  scopes        String[]

  isActive      Boolean  @default(true)
  lastSyncAt    DateTime?
  syncFrequency Int      @default(60) // minutes

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([patientId, provider])
  @@index([patientId])
  @@map("health_device_connections")
}

enum HealthProvider {
  APPLE_HEALTH
  SAMSUNG_HEALTH
  GOOGLE_FIT
  FITBIT
  GARMIN
  WITHINGS
  MANUAL
}

model HealthMetric {
  id          String   @id @default(uuid())
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  metricType  HealthMetricType
  value       Decimal  @db.Decimal(10, 2)
  unit        String

  // Additional data
  source      HealthProvider @default(MANUAL)
  metadata    Json?

  // Time tracking
  recordedAt  DateTime
  syncedAt    DateTime @default(now())

  createdAt   DateTime @default(now())

  @@index([patientId, metricType])
  @@index([patientId, recordedAt])
  @@map("health_metrics")
}

enum HealthMetricType {
  STEPS
  HEART_RATE
  HEART_RATE_RESTING
  HEART_RATE_VARIABILITY
  BLOOD_PRESSURE_SYSTOLIC
  BLOOD_PRESSURE_DIASTOLIC
  BLOOD_OXYGEN
  BLOOD_GLUCOSE
  BODY_TEMPERATURE
  WEIGHT
  HEIGHT
  BMI
  BODY_FAT
  SLEEP_DURATION
  SLEEP_QUALITY
  CALORIES_BURNED
  CALORIES_CONSUMED
  WATER_INTAKE
  STRESS_LEVEL
  RESPIRATORY_RATE
  ACTIVE_MINUTES
  DISTANCE_WALKED
  FLOORS_CLIMBED
}

model FitnessActivity {
  id            String   @id @default(uuid())
  patientId     String
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  activityType  FitnessActivityType
  name          String
  description   String?

  // Duration and intensity
  durationMinutes Int
  intensity     ActivityIntensity @default(MODERATE)

  // Metrics
  caloriesBurned  Int?
  distanceKm      Decimal? @db.Decimal(6, 2)
  steps           Int?
  avgHeartRate    Int?
  maxHeartRate    Int?

  // Exercise details
  sets            Int?
  reps            Int?
  weightKg        Decimal? @db.Decimal(6, 2)

  // Location (for outdoor activities)
  location        String?
  routeData       Json?

  // Source
  source          HealthProvider @default(MANUAL)
  externalId      String?

  // Time
  startTime       DateTime
  endTime         DateTime?

  // Notes and ratings
  notes           String?
  moodBefore      Int?     // 1-5
  moodAfter       Int?     // 1-5
  difficultyRating Int?    // 1-5

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([patientId, activityType])
  @@index([patientId, startTime])
  @@map("fitness_activities")
}

enum FitnessActivityType {
  // Cardio
  WALKING
  RUNNING
  CYCLING
  SWIMMING
  HIIT
  ELLIPTICAL
  ROWING
  JUMP_ROPE
  DANCING
  AEROBICS
  STAIR_CLIMBING

  // Strength
  WEIGHT_TRAINING
  BODYWEIGHT
  RESISTANCE_BANDS
  CROSSFIT
  POWERLIFTING
  CALISTHENICS

  // Flexibility & Mind-Body
  YOGA
  PILATES
  STRETCHING
  TAI_CHI
  MEDITATION
  BREATHING_EXERCISES

  // Sports
  BASKETBALL
  FOOTBALL
  TENNIS
  BADMINTON
  VOLLEYBALL
  GOLF
  SOCCER
  CRICKET
  MARTIAL_ARTS
  BOXING

  // Other
  HIKING
  CLIMBING
  SKIING
  SNOWBOARDING
  SURFING
  KAYAKING
  OTHER
}

enum ActivityIntensity {
  LIGHT
  MODERATE
  VIGOROUS
  VERY_VIGOROUS
}

model FitnessGoal {
  id            String   @id @default(uuid())
  patientId     String
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  goalType      FitnessGoalType
  targetValue   Decimal  @db.Decimal(10, 2)
  currentValue  Decimal  @db.Decimal(10, 2) @default(0)
  unit          String

  frequency     GoalFrequency @default(DAILY)

  startDate     DateTime
  endDate       DateTime?

  isActive      Boolean  @default(true)
  isCompleted   Boolean  @default(false)
  completedAt   DateTime?

  // AI recommendations
  aiRecommendations Json?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([patientId, goalType])
  @@map("fitness_goals")
}

enum FitnessGoalType {
  STEPS_DAILY
  CALORIES_BURNED
  WORKOUT_MINUTES
  WORKOUT_SESSIONS
  WEIGHT_LOSS
  WEIGHT_GAIN
  MUSCLE_GAIN
  FLEXIBILITY
  ENDURANCE
  STRENGTH
  WATER_INTAKE
  SLEEP_HOURS
  MEDITATION_MINUTES
  DISTANCE_RUNNING
  DISTANCE_WALKING
  CUSTOM
}

enum GoalFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  ONE_TIME
}

model NutritionLog {
  id            String   @id @default(uuid())
  patientId     String
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  mealType      MealType
  mealName      String
  description   String?

  // Nutritional info
  calories      Int?
  protein       Decimal? @db.Decimal(6, 2)
  carbohydrates Decimal? @db.Decimal(6, 2)
  fat           Decimal? @db.Decimal(6, 2)
  fiber         Decimal? @db.Decimal(6, 2)
  sugar         Decimal? @db.Decimal(6, 2)
  sodium        Decimal? @db.Decimal(6, 2)

  // Serving info
  servingSize   String?
  servings      Decimal? @db.Decimal(4, 2) @default(1)

  // Food items
  foodItems     Json?    // Array of food items with details

  // Photo
  photoUrl      String?

  // AI analysis
  aiAnalysis    Json?
  healthScore   Int?     // 1-100
  aiGenerated   Boolean  @default(false) // Was this meal logged via AI photo analysis?
  userVerified  Boolean  @default(false) // Did user verify AI-detected foods?
  aiConfidence  Float?   // 0.0-1.0 confidence in AI detection

  loggedAt      DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([patientId, mealType])
  @@index([patientId, loggedAt])
  @@map("nutrition_logs")
}

model NutritionPlan {
  id            String   @id @default(uuid())
  patientId     String
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  name          String
  description   String?
  goal          NutritionGoalType

  // Daily targets
  targetCalories    Int
  targetProtein     Decimal? @db.Decimal(6, 2)
  targetCarbs       Decimal? @db.Decimal(6, 2)
  targetFat         Decimal? @db.Decimal(6, 2)
  targetFiber       Decimal? @db.Decimal(6, 2)
  targetWater       Decimal? @db.Decimal(4, 2) // liters

  // Restrictions
  dietaryRestrictions String[]
  allergies           String[]
  preferences         String[]

  // Meal plan
  mealPlan      Json?    // Weekly meal suggestions

  // AI generated
  isAiGenerated Boolean  @default(false)
  aiNotes       String?  @db.Text

  startDate     DateTime
  endDate       DateTime?
  isActive      Boolean  @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([patientId])
  @@map("nutrition_plans")
}

enum NutritionGoalType {
  WEIGHT_LOSS
  WEIGHT_GAIN
  MUSCLE_BUILDING
  MAINTAIN_WEIGHT
  IMPROVE_ENERGY
  HEART_HEALTH
  DIABETES_MANAGEMENT
  DIGESTIVE_HEALTH
  GENERAL_WELLNESS
  ATHLETIC_PERFORMANCE
  PREGNANCY
  POSTPARTUM
}

model WellnessGoal {
  id            String   @id @default(uuid())
  patientId     String
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  category      WellnessCategory
  title         String
  description   String?

  // Target
  targetValue   Decimal? @db.Decimal(10, 2)
  currentValue  Decimal? @db.Decimal(10, 2)
  unit          String?

  // Progress tracking
  milestones    Json?    // Array of milestone checkpoints

  // AI coaching
  aiCoachNotes  Json?    // AI-generated tips and encouragement

  priority      Int      @default(1) // 1-5

  startDate     DateTime
  targetDate    DateTime?

  status        WellnessGoalStatus @default(ACTIVE)
  completedAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([patientId, category])
  @@map("wellness_goals")
}

enum WellnessCategory {
  PHYSICAL_FITNESS
  MENTAL_HEALTH
  NUTRITION
  SLEEP
  STRESS_MANAGEMENT
  HYDRATION
  WEIGHT_MANAGEMENT
  CHRONIC_DISEASE_MANAGEMENT
  PREVENTIVE_CARE
  SOCIAL_WELLNESS
  MINDFULNESS
  HABIT_BUILDING
}

enum WellnessGoalStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ABANDONED
}

model WellnessAssessment {
  id            String   @id @default(uuid())
  patientId     String
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  assessmentType WellnessAssessmentType

  // Scores
  overallScore  Int      // 1-100
  categoryScores Json    // Breakdown by category

  // Analysis
  strengths     String[]
  areasToImprove String[]

  // AI recommendations
  recommendations Json   // Array of personalized recommendations
  actionPlan    Json?    // Suggested action items

  // Risk assessment
  healthRisks   Json?    // Identified health risks

  assessedAt    DateTime @default(now())
  validUntil    DateTime?

  createdAt     DateTime @default(now())

  @@index([patientId])
  @@map("wellness_assessments")
}

// ==================== PATIENT SETTINGS & PREFERENCES ====================

model PatientNotificationPreference {
  id                     String   @id @default(uuid())
  patientId              String   @unique
  patient                Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Notification channels
  emailNotifications     Boolean  @default(true)
  smsNotifications       Boolean  @default(true)
  whatsappNotifications  Boolean  @default(false)

  // Notification types
  appointmentReminders   Boolean  @default(true)
  labResultsReady        Boolean  @default(true)
  prescriptionReminders  Boolean  @default(true)
  billingAlerts          Boolean  @default(true)
  promotionalEmails      Boolean  @default(false)

  // Timing preference
  reminderTime           String   @default("1_DAY")  // 30_MINS, 2_HOURS, 1_DAY, 2_DAYS

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("patient_notification_preferences")
}

model PatientCommunicationPreference {
  id                         String   @id @default(uuid())
  patientId                  String   @unique
  patient                    Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  preferredContactMethod     String   @default("EMAIL")  // EMAIL, SMS, WHATSAPP, PHONE
  preferredLanguage          String   @default("en")
  preferredTimeForCalls      String   @default("MORNING")  // MORNING, AFTERNOON, EVENING, ANYTIME
  allowMarketingCommunications Boolean @default(false)

  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  @@map("patient_communication_preferences")
}

enum WellnessAssessmentType {
  INITIAL
  PERIODIC
  GOAL_BASED
  COMPREHENSIVE
}

// ==================== INSURANCE CODING (ICD-10 / CPT) ====================

// Master ICD-10 code table
model ICD10Code {
  id               String   @id @default(uuid())
  hospitalId       String
  code             String   // e.g., "J18.9", "E11.65"
  description      String   // Full description
  shortDescription String?  // Short display name
  category         String   // Chapter/category, e.g., "Respiratory", "Endocrine"
  subcategory      String?  // More specific grouping
  dhaApproved      Boolean  @default(true)  // Dubai Health Authority approved
  specificityLevel Int      @default(3)     // 3=category, 4-7=more specific
  isUnspecified    Boolean  @default(false) // True for unspecified codes like "J18.9"
  preferredCode    String?  // More specific code to use instead
  isActive         Boolean  @default(true)
  isBillable       Boolean  @default(true)  // Can be used for billing
  effectiveDate    DateTime @default(now())
  terminationDate  DateTime?
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdBy        String?

  // Relations
  hospital               Hospital                 @relation(fields: [hospitalId], references: [id])
  payerRules             ICD10PayerRule[]
  icdCptMappings         ICD10CPTMapping[]        @relation("ICD10ToMapping")
  consultationDiagnoses  ConsultationDiagnosis[]
  dischargeDiagnoses     DischargeDiagnosis[]

  @@unique([hospitalId, code])
  @@index([hospitalId, category])
  @@index([hospitalId, dhaApproved])
  @@index([code])
  @@map("icd10_codes")
}

// Master CPT code table
model CPTCode {
  id                String   @id @default(uuid())
  hospitalId        String
  code              String   // e.g., "99213", "99214"
  description       String   // Full description
  shortDescription  String?  // Short display name
  category          String   // e.g., "E&M", "Surgery", "Radiology"
  subcategory       String?  // More specific grouping
  basePrice         Decimal  @db.Decimal(10, 2)  // Hospital standard price
  dhaPrice          Decimal? @db.Decimal(10, 2)  // DHA regulated price
  cashPrice         Decimal? @db.Decimal(10, 2)  // Cash patient price
  requiresPreAuth   Boolean  @default(false)     // Requires pre-authorization
  isActive          Boolean  @default(true)
  workRVU           Decimal? @db.Decimal(6, 2)   // Work relative value units
  facilityRVU       Decimal? @db.Decimal(6, 2)   // Facility RVU
  malpracticeRVU    Decimal? @db.Decimal(6, 2)   // Malpractice RVU
  globalPeriod      Int?     // Global surgery period in days (0, 10, 90)
  professionalComponent Boolean @default(false)  // Has professional component (26 modifier)
  technicalComponent    Boolean @default(false)  // Has technical component (TC modifier)
  effectiveDate     DateTime @default(now())
  terminationDate   DateTime?
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?

  // Bundling rules - JSON arrays of CPT codes
  bundledWith       String[]  // CPT codes typically bundled with this one
  excludedWith      String[]  // CPT codes that cannot be billed together (NCCI edits)
  requiresModifier  String[]  // Modifiers often needed with this code

  // Relations
  hospital               Hospital                 @relation(fields: [hospitalId], references: [id])
  payerRules             CPTPayerRule[]
  icdCptMappings         ICD10CPTMapping[]        @relation("CPTToMapping")
  consultationProcedures ConsultationProcedure[]
  dischargeProcedures    DischargeProcedure[]

  @@unique([hospitalId, code])
  @@index([hospitalId, category])
  @@index([hospitalId, requiresPreAuth])
  @@index([code])
  @@map("cpt_codes")
}

// CPT Modifiers (e.g., 25, 59, 76, TC, 26)
model CPTModifier {
  id           String   @id @default(uuid())
  hospitalId   String
  code         String   // e.g., "25", "59", "76", "TC", "26"
  description  String
  priceImpact  Decimal? @db.Decimal(5, 4)  // Multiplier (e.g., 0.50 for 50% reduction)
  isActive     Boolean  @default(true)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  hospital Hospital @relation(fields: [hospitalId], references: [id])

  @@unique([hospitalId, code])
  @@map("cpt_modifiers")
}

// Insurance Payer master
model InsurancePayer {
  id                String   @id @default(uuid())
  hospitalId        String
  name              String   // e.g., "Daman", "Neuron", "ADNIC"
  code              String   // Short code
  regulator         String?  // e.g., "DHA", "DOH", "HAAD"
  claimPlatform     String?  // e.g., "eClaimLink", "SHIFA", "Riayati"
  claimSubmissionDeadline Int? // Days after service
  appealDeadline    Int?     // Days after rejection
  preAuthRequired   Boolean  @default(false)
  preAuthPhone      String?
  preAuthEmail      String?
  preAuthPortal     String?
  contactPhone      String?
  contactEmail      String?
  address           String?
  paymentTerms      Int?     // Days to payment
  isActive          Boolean  @default(true)
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?

  // Relations
  hospital     Hospital         @relation(fields: [hospitalId], references: [id])
  icdRules     ICD10PayerRule[]
  cptRules     CPTPayerRule[]

  @@unique([hospitalId, code])
  @@index([hospitalId, isActive])
  @@map("insurance_payers")
}

// Payer-specific rules for ICD-10 codes
model ICD10PayerRule {
  id                 String   @id @default(uuid())
  payerId            String
  icd10CodeId        String
  isCovered          Boolean  @default(true)
  requiresPreAuth    Boolean  @default(false)
  maxVisitsPerYear   Int?     // Visit limit
  waitingPeriodDays  Int?     // Coverage waiting period
  copayAmount        Decimal? @db.Decimal(10, 2)
  copayPercentage    Decimal? @db.Decimal(5, 2)
  deductibleApplies  Boolean  @default(true)
  ageMinimum         Int?     // Age restrictions
  ageMaximum         Int?
  genderRestriction  String?  // "M", "F", or null for any
  priorDiagRequired  String?  // ICD code that must be documented first
  documentationNotes String?  // Required documentation
  effectiveDate      DateTime @default(now())
  terminationDate    DateTime?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  payer     InsurancePayer @relation(fields: [payerId], references: [id], onDelete: Cascade)
  icd10Code ICD10Code      @relation(fields: [icd10CodeId], references: [id], onDelete: Cascade)

  @@unique([payerId, icd10CodeId])
  @@index([payerId])
  @@index([icd10CodeId])
  @@map("icd10_payer_rules")
}

// Payer-specific rules for CPT codes
model CPTPayerRule {
  id                 String   @id @default(uuid())
  payerId            String
  cptCodeId          String
  isCovered          Boolean  @default(true)
  requiresPreAuth    Boolean  @default(false)
  priceOverride      Decimal? @db.Decimal(10, 2)  // Payer-specific price
  maxUnitsPerVisit   Int?     // Unit limit per encounter
  maxUnitsPerYear    Int?     // Annual limit
  frequencyLimit     String?  // e.g., "1/30days", "4/year"
  ageMinimum         Int?
  ageMaximum         Int?
  genderRestriction  String?
  placeOfService     String[] // Allowed place of service codes
  requiresModifier   String[] // Required modifiers for this payer
  documentationNotes String?
  effectiveDate      DateTime @default(now())
  terminationDate    DateTime?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  payer   InsurancePayer @relation(fields: [payerId], references: [id], onDelete: Cascade)
  cptCode CPTCode        @relation(fields: [cptCodeId], references: [id], onDelete: Cascade)

  @@unique([payerId, cptCodeId])
  @@index([payerId])
  @@index([cptCodeId])
  @@map("cpt_payer_rules")
}

// Medical necessity mappings - valid ICD-10 + CPT pairs
model ICD10CPTMapping {
  id               String   @id @default(uuid())
  hospitalId       String
  icd10CodeId      String
  cptCodeId        String
  validityScore    Decimal  @db.Decimal(3, 2) @default(1.00)  // 0.00-1.00 necessity strength
  isRequired       Boolean  @default(false)  // ICD required for CPT
  isCommon         Boolean  @default(true)   // Commonly paired
  documentation    String?  // Required documentation for this pair
  notes            String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdBy        String?

  // Relations
  hospital  Hospital  @relation(fields: [hospitalId], references: [id])
  icd10Code ICD10Code @relation("ICD10ToMapping", fields: [icd10CodeId], references: [id], onDelete: Cascade)
  cptCode   CPTCode   @relation("CPTToMapping", fields: [cptCodeId], references: [id], onDelete: Cascade)

  @@unique([hospitalId, icd10CodeId, cptCodeId])
  @@index([hospitalId])
  @@index([icd10CodeId])
  @@index([cptCodeId])
  @@map("icd10_cpt_mappings")
}

// ==================== CONSULTATION & DISCHARGE CODING ====================

// Diagnoses linked to a consultation (OPD)
model ConsultationDiagnosis {
  id               String   @id @default(uuid())
  consultationId   String
  icd10CodeId      String
  sequenceNumber   Int      @default(1)  // 1 = primary, 2+ = secondary
  isPrimary        Boolean  @default(false)
  isAdmitting      Boolean  @default(false)  // Reason for visit
  diagnosisType    DiagnosisType @default(FINAL)
  presentOnAdmission String? // Y, N, U, W (for IPD)
  notes            String?
  aiSuggested      Boolean  @default(false)  // Was this AI suggested
  aiConfidence     Decimal? @db.Decimal(3, 2) // AI confidence if suggested
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdBy        String?

  // Relations
  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  icd10Code    ICD10Code    @relation(fields: [icd10CodeId], references: [id])

  @@unique([consultationId, icd10CodeId])
  @@index([consultationId])
  @@map("consultation_diagnoses")
}

// Procedures linked to a consultation (OPD)
model ConsultationProcedure {
  id               String   @id @default(uuid())
  consultationId   String
  cptCodeId        String
  modifiers        String[] // Applied modifiers
  units            Int      @default(1)
  serviceDate      DateTime @default(now())
  price            Decimal  @db.Decimal(10, 2)
  notes            String?
  aiSuggested      Boolean  @default(false)
  aiConfidence     Decimal? @db.Decimal(3, 2)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdBy        String?

  // Relations
  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  cptCode      CPTCode      @relation(fields: [cptCodeId], references: [id])

  @@index([consultationId])
  @@map("consultation_procedures")
}

// Discharge coding for IPD admissions
model DischargeCoding {
  id               String   @id @default(uuid())
  admissionId      String   @unique
  status           DischargeCodingStatus @default(DRAFT)
  codingCompleteAt DateTime?
  codedBy          String?
  reviewedBy       String?
  reviewedAt       DateTime?
  totalCharges     Decimal? @db.Decimal(12, 2)
  acceptancePrediction Decimal? @db.Decimal(3, 2) // AI predicted acceptance
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  admission   Admission            @relation(fields: [admissionId], references: [id], onDelete: Cascade)
  diagnoses   DischargeDiagnosis[]
  procedures  DischargeProcedure[]

  @@map("discharge_codings")
}

// Diagnoses for discharge (IPD)
model DischargeDiagnosis {
  id                 String   @id @default(uuid())
  dischargeCodingId  String
  icd10CodeId        String
  sequenceNumber     Int      @default(1)
  isPrimary          Boolean  @default(false)
  isAdmitting        Boolean  @default(false)
  diagnosisType      DiagnosisType @default(FINAL)
  presentOnAdmission String?  // Y, N, U, W
  notes              String?
  aiSuggested        Boolean  @default(false)
  aiConfidence       Decimal? @db.Decimal(3, 2)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  createdBy          String?

  // Relations
  dischargeCoding DischargeCoding @relation(fields: [dischargeCodingId], references: [id], onDelete: Cascade)
  icd10Code       ICD10Code       @relation(fields: [icd10CodeId], references: [id])

  @@unique([dischargeCodingId, icd10CodeId])
  @@index([dischargeCodingId])
  @@map("discharge_diagnoses")
}

// Procedures for discharge (IPD)
model DischargeProcedure {
  id                String   @id @default(uuid())
  dischargeCodingId String
  cptCodeId         String
  modifiers         String[]
  units             Int      @default(1)
  serviceDate       DateTime
  price             Decimal  @db.Decimal(10, 2)
  performedBy       String?  // Doctor ID
  notes             String?
  aiSuggested       Boolean  @default(false)
  aiConfidence      Decimal? @db.Decimal(3, 2)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?

  // Relations
  dischargeCoding DischargeCoding @relation(fields: [dischargeCodingId], references: [id], onDelete: Cascade)
  cptCode         CPTCode         @relation(fields: [cptCodeId], references: [id])

  @@index([dischargeCodingId])
  @@map("discharge_procedures")
}

enum DiagnosisType {
  ADMITTING    // Initial diagnosis on admission
  PRINCIPAL    // Main condition after study
  FINAL        // Final confirmed diagnosis
  SECONDARY    // Contributing condition
  RULE_OUT     // Being investigated
}

enum DischargeCodingStatus {
  DRAFT        // Still being edited
  PENDING_REVIEW // Awaiting coder review
  REVIEWED     // Coder reviewed
  FINALIZED    // Locked for billing
  SUBMITTED    // Claim submitted
}

// =============================================================================
// A'MAD PRECISION HEALTH PLATFORM - GENOMICS, RECOMMENDATIONS, HEALTH SCORES
// =============================================================================

// Native Health Platform Data (HealthKit, Health Connect, Samsung Health)
model HealthDataPoint {
  id          String         @id @default(uuid())
  patientId   String
  hospitalId  String
  source      HealthPlatformSource
  dataType    HealthPlatformDataType
  value       Float
  unit        String
  timestamp   DateTime
  metadata    Json?
  syncedAt    DateTime       @default(now())

  patient     Patient        @relation(fields: [patientId], references: [id], onDelete: Cascade)
  hospital    Hospital       @relation(fields: [hospitalId], references: [id])

  @@index([patientId, dataType, timestamp])
  @@index([hospitalId])
  @@map("health_data_points")
}

enum HealthPlatformSource {
  GOOGLE_HEALTH_CONNECT
  APPLE_HEALTH_KIT
  SAMSUNG_HEALTH
  MANUAL
}

enum HealthPlatformDataType {
  STEPS
  SLEEP_DURATION
  SLEEP_STAGE
  HEART_RATE
  HEART_RATE_RESTING
  HRV
  WORKOUT
  CALORIES_BURNED
  BLOOD_OXYGEN
  STRESS_LEVEL
  BLOOD_PRESSURE_SYSTOLIC
  BLOOD_PRESSURE_DIASTOLIC
  BLOOD_GLUCOSE
  BODY_TEMPERATURE
  WEIGHT
  RESPIRATORY_RATE
  DISTANCE
  FLOORS_CLIMBED
  ACTIVE_MINUTES
}

// Genomic Profile from uploaded files (VCF, 23andMe, AncestryDNA)
model GenomicProfile {
  id          String           @id @default(uuid())
  patientId   String           @unique
  hospitalId  String
  source      GenomicSource
  fileName    String?          // Original uploaded file name
  fileHash    String           // SHA256 for deduplication
  fileUrl     String?          // S3 URL for raw file
  uploadedAt  DateTime         @default(now())
  processedAt DateTime?
  status      GenomicProcessingStatus @default(PENDING)
  errorMessage String?

  markers     GenomicMarker[]
  riskScores  GenomicRiskScore[]

  patient     Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)
  hospital    Hospital         @relation(fields: [hospitalId], references: [id])

  @@index([hospitalId])
  @@map("genomic_profiles")
}

enum GenomicSource {
  VCF
  TWENTYTHREE_AND_ME
  ANCESTRY_DNA
  MANUAL
}

enum GenomicProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Individual Genetic Markers from genomic profile
model GenomicMarker {
  id              String         @id @default(uuid())
  profileId       String
  rsId            String         // e.g., rs762551
  gene            String         // e.g., CYP1A2
  genotype        String         // e.g., "AC"
  category        GenomicMarkerCategory
  phenotype       String         // e.g., "Slow caffeine metabolizer"
  confidence      Float          // 0.0 - 1.0
  recommendations Json           // Array of recommendation strings
  metadata        Json?          // Additional SNP data

  profile         GenomicProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, category])
  @@index([rsId])
  @@map("genomic_markers")
}

enum GenomicMarkerCategory {
  METABOLISM       // Drug/nutrient metabolism
  NUTRITION        // Dietary needs (lactose, gluten, etc.)
  INFLAMMATION     // Inflammatory markers
  FITNESS          // Athletic performance
  SLEEP            // Sleep quality/circadian
  CARDIOVASCULAR   // Heart health
  MENTAL_HEALTH    // Cognitive/mood
  DETOXIFICATION   // Detox pathways
}

// Risk Scores calculated from genomic data
model GenomicRiskScore {
  id              String         @id @default(uuid())
  profileId       String
  condition       String         // e.g., "Type 2 Diabetes", "Coronary Heart Disease"
  riskLevel       GenomicRiskLevel
  percentile      Float          // Population percentile (0-100)
  confidenceScore Float          // 0.0 - 1.0
  contributingSnps Json          // Array of rsIds that contribute
  recommendations Json           // Array of recommendations
  calculatedAt    DateTime       @default(now())

  profile         GenomicProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("genomic_risk_scores")
}

enum GenomicRiskLevel {
  LOW
  BELOW_AVERAGE
  AVERAGE
  ABOVE_AVERAGE
  HIGH
}

// Patient Consent Management (HIPAA/GDPR compliance)
model PatientConsent {
  id          String       @id @default(uuid())
  patientId   String
  hospitalId  String
  consentType DataConsentType
  granted     Boolean
  grantedAt   DateTime?
  revokedAt   DateTime?
  ipAddress   String?
  userAgent   String?
  version     String       @default("1.0") // Consent form version

  patient     Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  hospital    Hospital     @relation(fields: [hospitalId], references: [id])

  @@unique([patientId, consentType])
  @@index([hospitalId])
  @@map("patient_consents")
}

enum DataConsentType {
  HEALTH_DATA_COLLECTION
  GENOMIC_ANALYSIS
  AI_RECOMMENDATIONS
  CLINICIAN_ACCESS
  DATA_SHARING_RESEARCH
  MEAL_PHOTO_ANALYSIS
}

// AI-Generated Recommendations
model Recommendation {
  id           String                 @id @default(uuid())
  patientId    String
  hospitalId   String
  category     RecommendationCategory
  priority     RecommendationPriority
  title        String
  description  String                 @db.Text
  reasoning    Json                   // Array of reasons explaining why
  dataSources  Json                   // What data informed this recommendation
  actionItems  Json?                  // Specific action steps
  validFrom    DateTime               @default(now())
  validUntil   DateTime
  status       RecommendationStatus   @default(ACTIVE)
  dismissedAt  DateTime?
  completedAt  DateTime?
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt

  patient      Patient                @relation(fields: [patientId], references: [id], onDelete: Cascade)
  hospital     Hospital               @relation(fields: [hospitalId], references: [id])
  feedback     RecommendationFeedback[]

  @@index([patientId, status])
  @@index([hospitalId])
  @@map("recommendations")
}

enum RecommendationCategory {
  NUTRITION
  SUPPLEMENT
  ACTIVITY
  SLEEP
  LIFESTYLE
  MEDICAL
  GENOMIC        // Based on genomic profile
  LAB_BASED      // Based on lab results
  WEARABLE_BASED // Based on wearable data
}

enum RecommendationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RecommendationStatus {
  ACTIVE
  DISMISSED
  COMPLETED
  EXPIRED
  SNOOZED
}

// User feedback on recommendations
model RecommendationFeedback {
  id               String         @id @default(uuid())
  recommendationId String
  helpful          Boolean?       // Was this recommendation helpful?
  followed         Boolean?       // Did the patient follow it?
  rating           Int?           // 1-5 star rating
  comment          String?        @db.Text
  createdAt        DateTime       @default(now())

  recommendation   Recommendation @relation(fields: [recommendationId], references: [id], onDelete: Cascade)

  @@index([recommendationId])
  @@map("recommendation_feedback")
}

// Daily Health Score (composite wellness metric)
model DailyHealthScore {
  id          String       @id @default(uuid())
  patientId   String
  hospitalId  String
  date        DateTime     @db.Date
  overall     Int          // 0-100
  sleep       Int          // 0-100
  activity    Int          // 0-100
  nutrition   Int          // 0-100
  recovery    Int          // 0-100 (HRV-based)
  compliance  Int          // 0-100 (goal adherence)
  stress      Int?         // 0-100 (if available)
  trend       HealthScoreTrend
  insights    Json         // Array of insight strings
  dataQuality Float        // 0.0-1.0 how much data was available
  calculatedAt DateTime    @default(now())

  patient     Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  hospital    Hospital     @relation(fields: [hospitalId], references: [id])

  @@unique([patientId, date])
  @@index([hospitalId])
  @@map("daily_health_scores")
}

enum HealthScoreTrend {
  IMPROVING
  STABLE
  DECLINING
  INSUFFICIENT_DATA
}

// Regional Food Database for AI Nutrition Analysis
model FoodItem {
  id              String   @id @default(uuid())
  hospitalId      String?  // null = global, otherwise hospital-specific
  name            String
  nameAr          String?  // Arabic name
  category        String   // e.g., "Grains", "Proteins", "Vegetables"
  subcategory     String?  // e.g., "Rice dishes", "Lamb"
  servingSize     Float
  servingUnit     String   // e.g., "g", "cup", "piece"

  // Macronutrients (per serving)
  calories        Float
  protein         Float    // grams
  carbs           Float    // grams
  fat             Float    // grams
  fiber           Float    // grams
  sugar           Float?   // grams
  sodium          Float?   // mg

  // Micronutrients (optional)
  vitaminA        Float?   // IU
  vitaminC        Float?   // mg
  vitaminD        Float?   // IU
  calcium         Float?   // mg
  iron            Float?   // mg
  potassium       Float?   // mg

  // Regional classification
  isRegional      Boolean  @default(false)
  region          String?  // "gulf", "levant", "north_african", "south_asian"
  cuisine         String?  // "emirati", "saudi", "lebanese", etc.

  // AI assistance
  commonAliases   String[] // Alternative names for AI matching
  imageUrl        String?  // Reference image
  isVerified      Boolean  @default(false)

  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  hospital        Hospital? @relation(fields: [hospitalId], references: [id])

  @@index([name])
  @@index([nameAr])
  @@index([hospitalId, category])
  @@map("food_items")
}

// Clinician Notes on Patient Health Summary
model ClinicianHealthNote {
  id          String   @id @default(uuid())
  patientId   String
  hospitalId  String
  clinicianId String   // User ID of the clinician
  noteType    ClinicianNoteType
  content     String   @db.Text
  isPrivate   Boolean  @default(false) // Not visible to patient
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  hospital    Hospital @relation(fields: [hospitalId], references: [id])
  clinician   User     @relation("ClinicianHealthNotes", fields: [clinicianId], references: [id])

  @@index([patientId])
  @@index([hospitalId])
  @@index([clinicianId])
  @@map("clinician_health_notes")
}

enum ClinicianNoteType {
  GENERAL
  GENOMIC_REVIEW
  WEARABLE_REVIEW
  LAB_INTERPRETATION
  RECOMMENDATION_OVERRIDE
  CARE_PLAN
}

// ==================== CRM MODULE ====================

model CRMLead {
  id                  String          @id @default(uuid())
  hospitalId          String
  leadNumber          String          @unique
  firstName           String
  lastName            String
  email               String?
  phone               String
  alternatePhone      String?
  dateOfBirth         DateTime?
  gender              Gender?
  address             String?
  city                String?
  state               String?
  zipCode             String?
  source              LeadSource
  sourceDetails       String?
  interestedIn        String[]
  preferredDoctor     String?
  preferredDate       DateTime?
  notes               String?         @db.Text
  status              LeadStatus      @default(NEW)
  priority            LeadPriority    @default(MEDIUM)
  score               Int             @default(0)
  assignedToId        String?
  assignedAt          DateTime?
  convertedToPatientId String?        @unique
  convertedAt         DateTime?
  conversionReason    String?
  lostReason          String?
  referredByPatientId String?
  referredByDoctorId  String?
  lastContactedAt     DateTime?
  nextFollowUpAt      DateTime?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  hospital            Hospital        @relation(fields: [hospitalId], references: [id])
  assignedTo          User?           @relation("LeadAssignment", fields: [assignedToId], references: [id])
  convertedPatient    Patient?        @relation(fields: [convertedToPatientId], references: [id])
  activities          CRMActivity[]
  communications      CRMCommunication[]
  tasks               CRMTask[]
  tags                CRMLeadTag[]

  @@unique([hospitalId, leadNumber])
  @@index([hospitalId, status])
  @@index([hospitalId, assignedToId])
  @@map("crm_leads")
}

model CRMCommunication {
  id                  String              @id @default(uuid())
  hospitalId          String
  leadId              String?
  patientId           String?
  channel             CommunicationChannel
  direction           CommunicationDirection
  subject             String?
  content             String              @db.Text
  templateId          String?
  status              CommunicationStatus @default(PENDING)
  scheduledAt         DateTime?
  sentAt              DateTime?
  deliveredAt         DateTime?
  readAt              DateTime?
  failedAt            DateTime?
  failureReason       String?
  externalMessageId   String?
  initiatedById       String
  campaignId          String?
  metadata            Json?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  hospital            Hospital            @relation(fields: [hospitalId], references: [id])
  lead                CRMLead?            @relation(fields: [leadId], references: [id])
  patient             Patient?            @relation(fields: [patientId], references: [id])
  initiatedBy         User                @relation("CRMCommunicationInitiator", fields: [initiatedById], references: [id])
  template            CRMTemplate?        @relation(fields: [templateId], references: [id])
  campaign            CRMCampaign?        @relation(fields: [campaignId], references: [id])

  @@index([hospitalId, leadId])
  @@index([hospitalId, patientId])
  @@map("crm_communications")
}

model CRMTemplate {
  id                  String          @id @default(uuid())
  hospitalId          String
  name                String
  description         String?
  channel             CommunicationChannel
  category            TemplateCategory
  subject             String?
  content             String          @db.Text
  variables           String[]
  whatsappTemplateId  String?
  isActive            Boolean         @default(true)
  usageCount          Int             @default(0)
  createdById         String
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  hospital            Hospital        @relation(fields: [hospitalId], references: [id])
  createdBy           User            @relation("CRMTemplateCreator", fields: [createdById], references: [id])
  communications      CRMCommunication[]
  campaigns           CRMCampaign[]

  @@unique([hospitalId, name])
  @@map("crm_templates")
}

model CRMActivity {
  id                  String          @id @default(uuid())
  hospitalId          String
  leadId              String?
  patientId           String?
  taskId              String?
  activityType        CRMActivityType
  title               String
  description         String?         @db.Text
  outcome             String?
  activityDate        DateTime        @default(now())
  duration            Int?
  performedById       String
  metadata            Json?
  createdAt           DateTime        @default(now())

  hospital            Hospital        @relation(fields: [hospitalId], references: [id])
  lead                CRMLead?        @relation(fields: [leadId], references: [id])
  performedBy         User            @relation("CRMActivityPerformer", fields: [performedById], references: [id])
  task                CRMTask?        @relation(fields: [taskId], references: [id])

  @@index([hospitalId, leadId])
  @@index([hospitalId, activityDate])
  @@map("crm_activities")
}

model CRMTask {
  id                  String          @id @default(uuid())
  hospitalId          String
  leadId              String?
  patientId           String?
  taskType            CRMTaskType
  title               String
  description         String?         @db.Text
  priority            TaskPriority    @default(NORMAL)
  assignedToId        String
  assignedById        String
  dueDate             DateTime
  reminderAt          DateTime?
  completedAt         DateTime?
  status              CRMTaskStatus   @default(PENDING)
  outcome             String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  hospital            Hospital        @relation(fields: [hospitalId], references: [id])
  lead                CRMLead?        @relation(fields: [leadId], references: [id])
  assignedTo          User            @relation("CRMTaskAssignee", fields: [assignedToId], references: [id])
  assignedBy          User            @relation("CRMTaskAssigner", fields: [assignedById], references: [id])
  activities          CRMActivity[]

  @@index([hospitalId, assignedToId, status])
  @@index([hospitalId, dueDate])
  @@map("crm_tasks")
}

model CRMCampaign {
  id                  String          @id @default(uuid())
  hospitalId          String
  name                String
  description         String?         @db.Text
  campaignType        CampaignType
  targetAudience      Json
  targetCount         Int             @default(0)
  channel             CommunicationChannel
  templateId          String?
  subject             String?
  content             String?         @db.Text
  status              CampaignStatus  @default(DRAFT)
  scheduledAt         DateTime?
  startedAt           DateTime?
  completedAt         DateTime?
  totalRecipients     Int             @default(0)
  sentCount           Int             @default(0)
  deliveredCount      Int             @default(0)
  openedCount         Int             @default(0)
  clickedCount        Int             @default(0)
  respondedCount      Int             @default(0)
  failedCount         Int             @default(0)
  convertedCount      Int             @default(0)
  budget              Decimal?        @db.Decimal(10, 2)
  actualCost          Decimal?        @db.Decimal(10, 2)
  createdById         String
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  hospital            Hospital        @relation(fields: [hospitalId], references: [id])
  createdBy           User            @relation("CRMCampaignCreator", fields: [createdById], references: [id])
  template            CRMTemplate?    @relation(fields: [templateId], references: [id])
  communications      CRMCommunication[]

  @@unique([hospitalId, name])
  @@map("crm_campaigns")
}

model CRMSurvey {
  id                  String          @id @default(uuid())
  hospitalId          String
  name                String
  description         String?
  surveyType          SurveyType
  questions           Json
  isActive            Boolean         @default(true)
  isAnonymous         Boolean         @default(false)
  triggerEvent        String?
  triggerDelay        Int?
  responseCount       Int             @default(0)
  avgRating           Decimal?        @db.Decimal(3, 2)
  avgNPS              Decimal?        @db.Decimal(4, 2)
  createdById         String
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  hospital            Hospital        @relation(fields: [hospitalId], references: [id])
  createdBy           User            @relation("CRMSurveyCreator", fields: [createdById], references: [id])
  responses           CRMSurveyResponse[]

  @@map("crm_surveys")
}

model CRMSurveyResponse {
  id                  String          @id @default(uuid())
  surveyId            String
  patientId           String?
  appointmentId       String?
  answers             Json
  overallRating       Int?
  npsScore            Int?
  sentiment           String?
  feedback            String?         @db.Text
  requiresFollowUp    Boolean         @default(false)
  followUpStatus      String?
  followUpById        String?
  followUpNotes       String?
  submittedAt         DateTime        @default(now())

  survey              CRMSurvey       @relation(fields: [surveyId], references: [id])
  patient             Patient?        @relation(fields: [patientId], references: [id])

  @@index([surveyId])
  @@map("crm_survey_responses")
}

model CRMTag {
  id                  String          @id @default(uuid())
  hospitalId          String
  name                String
  color               String          @default("#6366f1")
  category            String?

  hospital            Hospital        @relation(fields: [hospitalId], references: [id])
  leadTags            CRMLeadTag[]

  @@unique([hospitalId, name])
  @@map("crm_tags")
}

model CRMLeadTag {
  leadId              String
  tagId               String
  lead                CRMLead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  tag                 CRMTag          @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([leadId, tagId])
  @@map("crm_lead_tags")
}

model CRMSettings {
  id                  String          @id @default(uuid())
  hospitalId          String          @unique
  autoAssignLeads     Boolean         @default(false)
  leadScoreThreshold  Int             @default(70)
  autoFollowUpDays    Int             @default(7)
  reminderHoursBefore Int             @default(24)
  autoSurveyEnabled   Boolean         @default(true)
  postVisitSurveyId   String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  hospital            Hospital        @relation(fields: [hospitalId], references: [id])

  @@map("crm_settings")
}

// CRM Enums
enum LeadSource {
  WEBSITE
  PHONE_CALL
  WALK_IN
  REFERRAL_PATIENT
  REFERRAL_DOCTOR
  SOCIAL_MEDIA
  GOOGLE_ADS
  FACEBOOK
  INSTAGRAM
  WHATSAPP
  EMAIL_INQUIRY
  HEALTH_CAMP
  CORPORATE
  INSURANCE_PARTNER
  OTHER
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  APPOINTMENT_SCHEDULED
  CONSULTATION_DONE
  CONVERTED
  LOST
  NURTURING
  DO_NOT_CONTACT
}

enum LeadPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum CommunicationChannel {
  PHONE_CALL
  SMS
  EMAIL
  WHATSAPP
  IN_PERSON
  VIDEO_CALL
}

enum CommunicationDirection {
  INBOUND
  OUTBOUND
}

enum CommunicationStatus {
  PENDING
  SCHEDULED
  SENT
  DELIVERED
  READ
  RESPONDED
  FAILED
  CANCELLED
}

enum TemplateCategory {
  APPOINTMENT_REMINDER
  FOLLOW_UP
  WELCOME
  FEEDBACK_REQUEST
  PROMOTION
  HEALTH_TIP
  BIRTHDAY
  CUSTOM
}

enum CRMActivityType {
  CALL_MADE
  CALL_RECEIVED
  EMAIL_SENT
  EMAIL_RECEIVED
  SMS_SENT
  WHATSAPP_SENT
  MEETING
  APPOINTMENT_BOOKED
  APPOINTMENT_COMPLETED
  FOLLOW_UP_SCHEDULED
  NOTE_ADDED
  STATUS_CHANGED
  TASK_COMPLETED
}

enum CRMTaskType {
  FOLLOW_UP_CALL
  FOLLOW_UP_EMAIL
  FOLLOW_UP_VISIT
  APPOINTMENT_SCHEDULING
  DOCUMENT_COLLECTION
  FEEDBACK_COLLECTION
  PAYMENT_REMINDER
  CUSTOM
}


enum CRMTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OVERDUE
}

enum CampaignType {
  HEALTH_CAMP
  PROMOTION
  AWARENESS
  SEASONAL
  FOLLOW_UP
  RE_ENGAGEMENT
  BIRTHDAY
  FEEDBACK
  CUSTOM
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
}

enum SurveyType {
  POST_VISIT
  POST_DISCHARGE
  NPS
  CSAT
  SERVICE_QUALITY
  DOCTOR_FEEDBACK
  CUSTOM
}

// ==================== DOCTOR ABSENCE MANAGEMENT ====================

enum AbsenceStatus {
  ACTIVE
  CANCELLED
}

enum AbsenceType {
  ANNUAL_LEAVE
  SICK_LEAVE
  CONFERENCE
  TRAINING
  PERSONAL
  EMERGENCY
  OTHER
}

model DoctorAbsence {
  id          String        @id @default(uuid())
  doctorId    String
  hospitalId  String
  startDate   DateTime      @db.Date
  endDate     DateTime      @db.Date
  absenceType AbsenceType   @default(OTHER)
  reason      String?                       // Additional reason text
  notes       String?                       // Additional details
  isFullDay   Boolean       @default(true)  // Full day or partial
  startTime   String?                       // If partial: "14:00"
  endTime     String?                       // If partial: "18:00"
  status      AbsenceStatus @default(ACTIVE)
  createdBy   String                        // User who created
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  doctor      Doctor   @relation(fields: [doctorId], references: [id])
  hospital    Hospital @relation(fields: [hospitalId], references: [id])

  @@index([doctorId, startDate, endDate])
  @@index([hospitalId, startDate])
  @@map("doctor_absences")
}

// ==================== HOSPITAL HOLIDAYS ====================

model HospitalHoliday {
  id          String   @id @default(uuid())
  hospitalId  String
  name        String                        // "Christmas", "National Day"
  date        DateTime @db.Date
  isRecurring Boolean  @default(false)      // Repeats yearly
  description String?
  isActive    Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  hospital    Hospital @relation(fields: [hospitalId], references: [id])

  @@unique([hospitalId, date])
  @@index([hospitalId, date])
  @@map("hospital_holidays")
}

// ==================== MULTI-DOCTOR CONSULTATION ====================

enum ParticipantRole {
  PRIMARY           // Main treating doctor
  CONSULTING        // Called for opinion
  ASSISTING         // Assisting in procedure
  SUPERVISING       // Supervising resident
}

model ConsultationParticipant {
  id              String          @id @default(uuid())
  consultationId  String
  doctorId        String
  role            ParticipantRole @default(CONSULTING)
  notes           String?                           // Contribution notes
  joinedAt        DateTime        @default(now())
  leftAt          DateTime?

  consultation    Consultation    @relation(fields: [consultationId], references: [id])
  doctor          Doctor          @relation(fields: [doctorId], references: [id])

  @@unique([consultationId, doctorId])
  @@index([consultationId])
  @@index([doctorId])
  @@map("consultation_participants")
}

// ==================== CONSULTANT REFERRAL ====================

enum ReferralUrgency {
  EMERGENCY  // Doctor books immediately
  URGENT     // Receptionist schedules within 24hrs
  ROUTINE    // Patient books via portal
}

enum ReferralStatus {
  PENDING     // Awaiting scheduling
  SCHEDULED   // Appointment booked
  COMPLETED   // Consultation completed
  CANCELLED   // Referral cancelled
  EXPIRED     // Not scheduled in time
}

model ConsultantReferral {
  id                    String          @id @default(uuid())
  hospitalId            String

  // Source
  sourceConsultationId  String?         // Link to originating consultation
  sourceAppointmentId   String          // Link to originating appointment
  referringDoctorId     String          // Doctor making referral
  patientId             String

  // Target
  targetDepartmentId    String          // Department being referred to
  targetDoctorId        String?         // Specific consultant (optional for ROUTINE)

  // Referral Details
  reason                String          // Reason for referral (text from voice/input)
  urgency               ReferralUrgency // EMERGENCY, URGENT, ROUTINE
  clinicalNotes         String?         // Additional clinical context

  // Status Tracking
  status                ReferralStatus  @default(PENDING)

  // Scheduling (filled when appointment created)
  scheduledAppointmentId String?        @unique
  scheduledAt           DateTime?       // When appointment was scheduled
  scheduledBy           String?         // User who scheduled (receptionist/patient/doctor)

  // Completion
  completedAt           DateTime?
  completionNotes       String?

  // Priority Flag (for patient portal booking)
  priorityBooking       Boolean         @default(false)
  priorityExpiresAt     DateTime?       // Priority expires after X days

  // Timestamps
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  expiresAt             DateTime?       // Referral expires if not scheduled

  // Relations
  hospital              Hospital        @relation(fields: [hospitalId], references: [id])
  sourceConsultation    Consultation?   @relation(fields: [sourceConsultationId], references: [id])
  sourceAppointment     Appointment     @relation("SourceAppointment", fields: [sourceAppointmentId], references: [id])
  referringDoctor       Doctor          @relation("ReferringDoctor", fields: [referringDoctorId], references: [id])
  patient               Patient         @relation(fields: [patientId], references: [id])
  targetDepartment      Department      @relation(fields: [targetDepartmentId], references: [id])
  targetDoctor          Doctor?         @relation("TargetDoctor", fields: [targetDoctorId], references: [id])
  scheduledAppointment  Appointment?    @relation("ReferralAppointment", fields: [scheduledAppointmentId], references: [id])

  @@index([hospitalId, status])
  @@index([hospitalId, urgency, status])
  @@index([patientId])
  @@index([targetDepartmentId, status])
  @@map("consultant_referrals")
}

// ==================== WHATSAPP BOT ====================

model WhatsAppSession {
  id                String   @id @default(uuid())
  phoneNumber       String   // User's WhatsApp number (E.164 format)
  hospitalId        String?  // Selected hospital ID
  patientId         String?  // Linked patient ID after registration/login
  conversationState Json     // Current conversation state (step, collected data, context)
  lastMessageAt     DateTime @default(now())
  expiresAt         DateTime // Session expires after 24 hours
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([phoneNumber])
  @@index([expiresAt])
  @@index([hospitalId])
  @@index([patientId])
  @@map("whatsapp_sessions")
}

// ==================== PROCUREMENT MODULE ====================

model Supplier {
  id                String   @id @default(uuid())
  hospitalId        String
  code              String   // auto-generated: SUP-001
  companyName       String
  tradeLicenseNo    String?
  taxRegistrationNo String?  // TRN/VAT
  category          SupplierCategory
  classification    SupplierClassification @default(C)
  status            SupplierStatus @default(PENDING)

  // Primary Contact
  contactPerson     String
  email             String
  phone             String
  website           String?

  // Address
  addressLine1      String
  addressLine2      String?
  city              String
  state             String?
  country           String   @default("UAE")
  postalCode        String?

  // Financial
  bankName          String?
  bankAccountNo     String?
  iban              String?
  swiftCode         String?
  paymentTerms      PaymentTerms @default(NET_30)
  creditLimit       Decimal? @db.Decimal(12, 2)
  currency          String   @default("AED")

  // Performance
  rating            Decimal  @default(0) @db.Decimal(3, 2)
  deliveryScore     Decimal  @default(0) @db.Decimal(3, 2)
  qualityScore      Decimal  @default(0) @db.Decimal(3, 2)
  priceScore        Decimal  @default(0) @db.Decimal(3, 2)
  totalOrders       Int      @default(0)

  // Meta
  leadTimeDays      Int      @default(7)
  notes             String?
  isBlacklisted     Boolean  @default(false)
  blacklistReason   String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  hospital          Hospital @relation(fields: [hospitalId], references: [id])
  contacts          SupplierContact[]
  documents         SupplierDocument[]
  purchaseOrders    PurchaseOrder[]
  quotations        RFQQuotation[]
  contracts         SupplierContract[]
  invoices          SupplierInvoice[]
  returns           SupplierReturn[]
  drugInventory     DrugInventory[]
  housekeepingInventory HousekeepingInventory[]

  @@unique([hospitalId, code])
  @@index([hospitalId, category])
  @@index([hospitalId, status])
  @@map("suppliers")
}

model SupplierContact {
  id          String @id @default(uuid())
  supplierId  String
  name        String
  designation String?
  email       String?
  phone       String?
  isPrimary   Boolean @default(false)
  createdAt   DateTime @default(now())

  supplier    Supplier @relation(fields: [supplierId], references: [id])

  @@map("supplier_contacts")
}

model SupplierDocument {
  id          String   @id @default(uuid())
  supplierId  String
  type        SupplierDocType
  name        String
  filePath    String
  expiryDate  DateTime?
  isVerified  Boolean  @default(false)
  uploadedAt  DateTime @default(now())

  supplier    Supplier @relation(fields: [supplierId], references: [id])

  @@map("supplier_documents")
}

model SupplierContract {
  id            String   @id @default(uuid())
  hospitalId    String
  supplierId    String
  contractNo    String
  type          ContractType
  startDate     DateTime
  endDate       DateTime
  value         Decimal? @db.Decimal(12, 2)
  terms         String?
  status        ContractStatus @default(ACTIVE)
  documentPath  String?
  renewalAlert  Boolean  @default(true)
  alertDaysBefore Int    @default(30)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  supplier      Supplier @relation(fields: [supplierId], references: [id])
  contractItems ContractItem[]

  @@unique([hospitalId, contractNo])
  @@map("supplier_contracts")
}

model ContractItem {
  id          String  @id @default(uuid())
  contractId  String
  itemName    String
  itemCode    String?
  unit        String
  agreedPrice Decimal @db.Decimal(10, 2)
  minQty      Int?
  maxQty      Int?

  contract    SupplierContract @relation(fields: [contractId], references: [id])

  @@map("contract_items")
}

model PurchaseRequisition {
  id              String   @id @default(uuid())
  hospitalId      String
  prNumber        String   // PR-{HOSP}-{YYYY}-{SEQ}
  requestedById   String
  departmentId    String
  urgency         PRUrgency @default(ROUTINE)
  status          PRStatus  @default(DRAFT_PR)
  justification   String?
  requiredDate    DateTime?
  totalEstimated  Decimal  @db.Decimal(12, 2) @default(0)
  approvedAt      DateTime?
  approvedById    String?
  rejectedAt      DateTime?
  rejectedById    String?
  rejectionReason String?
  notes           String?
  isAutoGenerated Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  hospital        Hospital @relation(fields: [hospitalId], references: [id])
  requestedBy     User     @relation("PRRequestedBy", fields: [requestedById], references: [id])
  department      Department @relation(fields: [departmentId], references: [id])
  items           PRItem[]
  approvals       PRApproval[]
  purchaseOrders  PurchaseOrder[]

  @@unique([hospitalId, prNumber])
  @@index([hospitalId, status])
  @@index([hospitalId, departmentId])
  @@map("purchase_requisitions")
}

model PRItem {
  id                String  @id @default(uuid())
  prId              String
  itemType          ProcurementItemType
  itemReferenceId   String?
  itemName          String
  itemCode          String?
  specification     String?
  unit              String
  quantity          Int
  estimatedUnitCost Decimal @db.Decimal(10, 2)
  estimatedTotal    Decimal @db.Decimal(12, 2)
  preferredSupplier String?
  notes             String?

  requisition       PurchaseRequisition @relation(fields: [prId], references: [id], onDelete: Cascade)
  poItems           POItem[]

  @@map("pr_items")
}

model PRApproval {
  id         String   @id @default(uuid())
  prId       String
  approverId String
  level      Int
  status     ApprovalStatus @default(PENDING_APPROVAL_STATUS)
  comments   String?
  actedAt    DateTime?
  createdAt  DateTime @default(now())

  requisition PurchaseRequisition @relation(fields: [prId], references: [id])
  approver    User @relation("PRApprover", fields: [approverId], references: [id])

  @@map("pr_approvals")
}

model RequestForQuotation {
  id            String   @id @default(uuid())
  hospitalId    String
  rfqNumber     String
  prId          String?
  status        RFQStatus @default(OPEN)
  deadline      DateTime
  notes         String?
  createdById   String
  evaluatedById String?
  evaluatedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  items         RFQItem[]
  quotations    RFQQuotation[]
  suppliers     RFQSupplier[]

  @@unique([hospitalId, rfqNumber])
  @@map("request_for_quotations")
}

model RFQItem {
  id            String @id @default(uuid())
  rfqId         String
  itemName      String
  itemCode      String?
  specification String?
  unit          String
  quantity      Int

  rfq           RequestForQuotation @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  quotationItems RFQQuotationItem[]

  @@map("rfq_items")
}

model RFQSupplier {
  id         String   @id @default(uuid())
  rfqId      String
  supplierId String
  invitedAt  DateTime @default(now())
  respondedAt DateTime?

  rfq        RequestForQuotation @relation(fields: [rfqId], references: [id])

  @@map("rfq_suppliers")
}

model RFQQuotation {
  id            String   @id @default(uuid())
  rfqId         String
  supplierId    String
  quotationRef  String?
  totalAmount   Decimal  @db.Decimal(12, 2)
  deliveryDays  Int?
  paymentTerms  String?
  validUntil    DateTime?
  documentPath  String?
  isSelected    Boolean  @default(false)
  notes         String?
  submittedAt   DateTime @default(now())

  rfq           RequestForQuotation @relation(fields: [rfqId], references: [id])
  supplier      Supplier @relation(fields: [supplierId], references: [id])
  items         RFQQuotationItem[]

  @@map("rfq_quotations")
}

model RFQQuotationItem {
  id          String  @id @default(uuid())
  quotationId String
  rfqItemId   String
  unitPrice   Decimal @db.Decimal(10, 2)
  totalPrice  Decimal @db.Decimal(12, 2)
  leadDays    Int?
  notes       String?

  quotation   RFQQuotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  rfqItem     RFQItem @relation(fields: [rfqItemId], references: [id])

  @@map("rfq_quotation_items")
}

model PurchaseOrder {
  id              String   @id @default(uuid())
  hospitalId      String
  poNumber        String
  supplierId      String
  prId            String?
  type            POType   @default(STANDARD)
  status          POStatus @default(DRAFT_PO)

  // Dates
  orderDate       DateTime @default(now())
  expectedDate    DateTime?
  deliveryDate    DateTime?

  // Amounts
  subtotal        Decimal  @db.Decimal(12, 2)
  discount        Decimal  @default(0) @db.Decimal(10, 2)
  tax             Decimal  @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal  @db.Decimal(12, 2)

  // Terms
  paymentTerms    PaymentTerms @default(NET_30)
  shippingTerms   String?
  deliveryAddress String?
  specialInstructions String?

  // Approval
  approvedAt      DateTime?
  approvedById    String?
  cancelledAt     DateTime?
  cancelledById   String?
  cancellationReason String?

  // Versioning
  version         Int      @default(1)
  isAmended       Boolean  @default(false)
  parentPOId      String?

  notes           String?
  createdById     String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  hospital        Hospital @relation(fields: [hospitalId], references: [id])
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  requisition     PurchaseRequisition? @relation(fields: [prId], references: [id])
  items           POItem[]
  grns            GoodsReceiptNote[]
  invoices        SupplierInvoice[]
  approvals       POApproval[]

  @@unique([hospitalId, poNumber])
  @@index([hospitalId, status])
  @@index([hospitalId, supplierId])
  @@map("purchase_orders")
}

model POItem {
  id            String  @id @default(uuid())
  poId          String
  prItemId      String?
  itemType      ProcurementItemType
  itemReferenceId String?
  itemName      String
  itemCode      String?
  unit          String
  orderedQty    Int
  receivedQty   Int     @default(0)
  unitPrice     Decimal @db.Decimal(10, 2)
  totalPrice    Decimal @db.Decimal(12, 2)
  notes         String?

  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)
  prItem        PRItem? @relation(fields: [prItemId], references: [id])
  grnItems      GRNItem[]

  @@map("po_items")
}

model POApproval {
  id         String   @id @default(uuid())
  poId       String
  approverId String
  level      Int
  status     ApprovalStatus @default(PENDING_APPROVAL_STATUS)
  comments   String?
  actedAt    DateTime?
  createdAt  DateTime @default(now())

  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id])
  approver      User @relation("POApprover", fields: [approverId], references: [id])

  @@map("po_approvals")
}

model GoodsReceiptNote {
  id              String   @id @default(uuid())
  hospitalId      String
  grnNumber       String
  poId            String
  receivedById    String
  receiptDate     DateTime @default(now())
  status          GRNStatus @default(DRAFT_GRN)
  deliveryNoteRef String?
  notes           String?
  inspectedById   String?
  inspectedAt     DateTime?
  inspectionStatus InspectionStatus?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  purchaseOrder   PurchaseOrder @relation(fields: [poId], references: [id])
  receivedBy      User @relation("GRNReceivedBy", fields: [receivedById], references: [id])
  items           GRNItem[]

  @@unique([hospitalId, grnNumber])
  @@map("goods_receipt_notes")
}

model GRNItem {
  id              String  @id @default(uuid())
  grnId           String
  poItemId        String
  receivedQty     Int
  acceptedQty     Int
  rejectedQty     Int     @default(0)
  rejectionReason String?
  batchNumber     String?
  expiryDate      DateTime?
  manufacturingDate DateTime?
  storageLocation String?
  condition       ItemCondition @default(GOOD)
  notes           String?

  grn             GoodsReceiptNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
  poItem          POItem @relation(fields: [poItemId], references: [id])

  @@map("grn_items")
}

model SupplierInvoice {
  id              String  @id @default(uuid())
  hospitalId      String
  invoiceNumber   String
  supplierId      String
  poId            String
  invoiceDate     DateTime
  dueDate         DateTime?
  amount          Decimal @db.Decimal(12, 2)
  taxAmount       Decimal @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal @db.Decimal(12, 2)
  matchStatus     InvoiceMatchStatus @default(UNMATCHED)
  paymentStatus   InvoicePaymentStatus @default(PENDING)
  paidAmount      Decimal @default(0) @db.Decimal(12, 2)
  paidAt          DateTime?
  documentPath    String?
  matchedById     String?
  matchedAt       DateTime?
  discrepancyNotes String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  supplier        Supplier @relation(fields: [supplierId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [poId], references: [id])

  @@unique([hospitalId, invoiceNumber, supplierId])
  @@map("supplier_invoices")
}

model SupplierReturn {
  id            String   @id @default(uuid())
  hospitalId    String
  returnNumber  String
  supplierId    String
  poId          String?
  grnId         String?
  reason        ReturnReason
  status        ReturnStatus @default(DRAFT_RETURN)
  totalAmount   Decimal  @db.Decimal(12, 2)
  notes         String?
  approvedById  String?
  approvedAt    DateTime?
  shippedAt     DateTime?
  creditNoteRef String?
  creditAmount  Decimal? @db.Decimal(12, 2)
  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  supplier      Supplier @relation(fields: [supplierId], references: [id])
  items         SupplierReturnItem[]

  @@unique([hospitalId, returnNumber])
  @@map("supplier_returns")
}

model SupplierReturnItem {
  id          String  @id @default(uuid())
  returnId    String
  itemName    String
  itemCode    String?
  quantity    Int
  unitPrice   Decimal @db.Decimal(10, 2)
  totalPrice  Decimal @db.Decimal(12, 2)
  reason      String?

  return      SupplierReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)

  @@map("supplier_return_items")
}

model ApprovalWorkflow {
  id          String   @id @default(uuid())
  hospitalId  String
  name        String
  type        WorkflowType
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  levels      ApprovalLevel[]

  @@map("approval_workflows")
}

model ApprovalLevel {
  id           String   @id @default(uuid())
  workflowId   String
  level        Int
  approverRole String
  approverId   String?
  amountMin    Decimal? @db.Decimal(12, 2)
  amountMax    Decimal? @db.Decimal(12, 2)
  department   String?
  isRequired   Boolean  @default(true)

  workflow     ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@map("approval_levels")
}

// ==================== PROCUREMENT ENUMS ====================

enum SupplierCategory {
  PHARMACEUTICALS
  MEDICAL_DEVICES
  LAB_CONSUMABLES
  SURGICAL_SUPPLIES
  HOUSEKEEPING
  IT_EQUIPMENT
  FOOD_DIETARY
  GENERAL
  @@map("supplier_category")
}

enum SupplierClassification {
  A
  B
  C
  @@map("supplier_classification")
}

enum SupplierStatus {
  PENDING
  APPROVED
  SUSPENDED
  BLACKLISTED
  @@map("supplier_status")
}

enum SupplierDocType {
  TRADE_LICENSE
  TAX_CERTIFICATE
  INSURANCE
  QUALITY_CERT
  ISO_CERT
  OTHER
  @@map("supplier_doc_type")
}

enum ContractType {
  RATE_AGREEMENT
  AMC
  SERVICE_LEVEL
  SUPPLY_AGREEMENT
  @@map("contract_type")
}

enum ContractStatus {
  DRAFT_CONTRACT
  ACTIVE
  EXPIRED
  TERMINATED
  @@map("contract_status")
}

enum PRUrgency {
  ROUTINE
  URGENT
  EMERGENCY_PR
  @@map("pr_urgency")
}

enum PRStatus {
  DRAFT_PR
  SUBMITTED
  PENDING_APPROVAL
  APPROVED_PR
  PARTIALLY_ORDERED
  FULLY_ORDERED
  CLOSED_PR
  REJECTED_PR
  CANCELLED_PR
  @@map("pr_status")
}

enum RFQStatus {
  OPEN
  CLOSED_RFQ
  EVALUATED
  CANCELLED_RFQ
  @@map("rfq_status")
}

enum POType {
  STANDARD
  BLANKET
  EMERGENCY_PO
  CONTRACT_RELEASE
  @@map("po_type")
}

enum POStatus {
  DRAFT_PO
  PENDING_APPROVAL_PO
  APPROVED_PO
  SENT_TO_SUPPLIER
  PARTIALLY_RECEIVED
  FULLY_RECEIVED
  CLOSED_PO
  CANCELLED_PO
  AMENDED
  @@map("po_status")
}

enum GRNStatus {
  DRAFT_GRN
  PENDING_INSPECTION
  APPROVED_GRN
  REJECTED_GRN
  @@map("grn_status")
}

enum InspectionStatus {
  PASSED
  FAILED
  CONDITIONAL
  @@map("inspection_status")
}

enum ItemCondition {
  GOOD
  DAMAGED
  EXPIRED_ITEM
  WRONG_ITEM
  @@map("item_condition")
}

enum InvoiceMatchStatus {
  UNMATCHED
  MATCHED
  PARTIAL_MATCH
  DISCREPANCY
  @@map("invoice_match_status")
}

enum InvoicePaymentStatus {
  PENDING
  APPROVED_PAYMENT
  PARTIALLY_PAID_INV
  PAID_INV
  OVERDUE
  @@map("invoice_payment_status")
}

enum PaymentTerms {
  IMMEDIATE
  NET_15
  NET_30
  NET_45
  NET_60
  NET_90
  @@map("payment_terms")
}

enum ReturnReason {
  DEFECTIVE
  EXPIRED_RETURN
  WRONG_ITEM_RETURN
  EXCESS
  QUALITY_ISSUE
  OTHER_RETURN
  @@map("return_reason")
}

enum ReturnStatus {
  DRAFT_RETURN
  PENDING_APPROVAL_RETURN
  APPROVED_RETURN
  SHIPPED
  CREDIT_RECEIVED
  CLOSED_RETURN
  CANCELLED_RETURN
  @@map("return_status")
}

enum ProcurementItemType {
  DRUG
  INVENTORY
  HOUSEKEEPING_ITEM
  ASSET
  LAB_CONSUMABLE
  OTHER_ITEM
  @@map("procurement_item_type")
}

enum WorkflowType {
  PR_WORKFLOW
  PO_WORKFLOW
  @@map("workflow_type")
}

enum ApprovalStatus {
  PENDING_APPROVAL_STATUS
  APPROVED_STATUS
  REJECTED_STATUS
  ESCALATED
  @@map("approval_status")
}
